# Story 4.3: Hardware Service Integration

## Status

Draft

## Story

**As a** system operator,  
**I want** all hardware services properly initialized and integrated,  
**So that** the drone can communicate with SDR hardware and flight controller.

## Acceptance Criteria

1. SDR hardware successfully initializes and validates connection on startup
2. MAVLink service configured and establishes connection with flight controller
3. State machine initializes with all safety states properly configured
4. Signal processor successfully integrates with state machine
5. Safety command pipeline fully implemented and tested
6. Complete service integration for all backend services
7. Service startup times optimized to under 10 seconds total
8. Health check endpoints report accurate status for all services

## Tasks / Subtasks

- [ ] Initialize SDR hardware service (AC: 1)
  - [ ] Implement SDR hardware detection in sdr_service.py
  - [ ] Add connection validation with timeout handling
  - [ ] Create fallback to mock SDR for development
  - [ ] Add SDR health check endpoint
  - [ ] Log SDR initialization status and parameters
- [ ] Configure MAVLink service (AC: 2)
  - [ ] Set up MAVLink connection parameters in config
  - [ ] Implement connection retry logic with backoff
  - [ ] Add MAVLink message handlers for required messages
  - [ ] Create MAVLink health check endpoint
  - [ ] Test with both SITL and real flight controller
- [ ] Initialize state machine with safety states (AC: 3)
  - [ ] Define all safety states (IDLE, SEARCHING, DETECTING, HOMING, HOLDING, EMERGENCY)
  - [ ] Implement state entry/exit actions
  - [ ] Add state transition validation
  - [ ] Implement state persistence for recovery
  - [ ] Add state machine health monitoring
- [ ] Integrate signal processor with state machine (AC: 4)
  - [ ] Connect RSSI readings to state transitions
  - [ ] Implement signal detection thresholds
  - [ ] Add signal quality filtering
  - [ ] Create state change event handlers
  - [ ] Test state transitions with simulated signals
- [ ] Implement safety command pipeline (AC: 5)
  - [ ] Create safety interlock checks before commands
  - [ ] Implement command validation and sanitization
  - [ ] Add emergency stop functionality
  - [ ] Create command audit logging
  - [ ] Test all safety scenarios
- [ ] **[CRITICAL] Complete service integrations for all backend services** (AC: 6)
  - [ ] Wire up all services in app.py initialization (BLOCKER for FR1-FR17)
  - [ ] Implement dependency injection for services
  - [ ] Add service lifecycle management
  - [ ] Create service shutdown handlers
  - [ ] Ensure all services communicate properly (signal processor, state machine, mavlink, sdr)
  - [ ] Test full system startup and shutdown
  - [ ] Verify all service dependencies are resolved
- [ ] Optimize service startup (AC: 7)
  - [ ] Profile current startup times
  - [ ] Parallelize independent service initialization
  - [ ] Implement lazy loading where appropriate
  - [ ] Add startup progress reporting
  - [ ] Target < 10 second total startup
- [ ] Implement health check endpoints (AC: 8)
  - [ ] Create /health endpoint for overall system
  - [ ] Add /health/sdr for SDR status
  - [ ] Add /health/mavlink for MAVLink status
  - [ ] Add /health/state for state machine status
  - [ ] Include detailed diagnostics in health responses

## Dev Notes

### Relevant Architecture Information

**Service Architecture** [Source: architecture/backend-architecture.md]:
- Services located in `src/backend/services/`
- Core app initialization in `src/backend/core/app.py`
- Dependency injection via `src/backend/core/dependencies.py`
- Service template pattern for consistency

**Hardware Services**:
- `sdr_service.py`: SDR hardware interface
- `signal_processor.py`: Signal processing pipeline
- `mavlink_service.py`: MAVLink communication
- `state_machine.py`: State management
- `homing_controller.py`: Homing algorithms

**State Machine States** [Source: Epic 3 requirements]:
- IDLE: System ready, no active mission
- SEARCHING: Executing search pattern
- DETECTING: Signal detected, analyzing
- HOMING: Approaching beacon
- HOLDING: Hovering over beacon
- EMERGENCY: Safety issue detected

**Safety Requirements** [Source: architecture/error-handling-strategy.md]:
- All commands must pass safety checks
- Emergency stop must work within 100ms
- State transitions must be atomic
- Failed services must not crash system
- All errors must be logged

**Service Initialization Pattern**:
```python
# From architecture docs
class SDRService:
    def __init__(self, config: Config):
        self.config = config
        self.device = None
        self.is_connected = False
    
    async def initialize(self):
        """Initialize SDR hardware"""
        try:
            self.device = await self._detect_device()
            self.is_connected = True
        except Exception as e:
            logger.error(f"SDR init failed: {e}")
            # Fall back to mock for development
            self.device = MockSDR()
    
    async def health_check(self) -> dict:
        """Return service health status"""
        return {
            "service": "sdr",
            "status": "healthy" if self.is_connected else "degraded",
            "connected": self.is_connected,
            "device": str(self.device)
        }
```

**MAVLink Configuration**:
- Connection string: "udp:127.0.0.1:14550" for SITL
- Serial connection for real hardware: "/dev/ttyACM0"
- Required messages: HEARTBEAT, GPS_RAW_INT, ATTITUDE
- Command messages: SET_POSITION_TARGET_LOCAL_NED

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]:
- Integration tests in `tests/backend/integration/`
- Mock hardware for unit tests
- Real hardware tests in SITL environment
- Health checks must return within 1 second
- All services must handle connection failures gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation from TODO consolidation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent*

### Debug Log References

*To be populated by Dev Agent*

### Completion Notes List

*To be populated by Dev Agent*

### File List

*To be populated by Dev Agent*

## QA Results

*To be populated by QA Agent*