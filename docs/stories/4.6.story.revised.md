# Story 4.6: Safety-Critical Coverage Compliance (REVISED - Zero Scope Creep)

## Status

BLOCKED - Requires Story 4.7 hardware mocks to proceed

## Story

**As a** safety compliance officer,
**I want** code coverage that meets industry standards for safety-critical systems,
**So that** PISAD meets the 80-90% coverage requirement for emergency SAR operations.

## Critical Reality Check

**Current State**: 62.56% coverage (4,827/7,715 lines)
**Industry Standard**: 60-70% for HAL systems (WE MEET THIS)
**Story Requirement**: 80% minimum for SAR operations
**Gap to Close**: 17.44% (1,346 lines need tests)

## Acceptance Criteria (TRACEABLE)

1. Backend unit test coverage increased from 62.56% to minimum 80%
2. Critical safety components achieve 90% coverage (4 files)
3. All 10 API routes achieve 80% coverage
4. Coverage enforcement gates prevent merging below 80%
5. Mutation testing on safety-critical code only

## SCOPE VALIDATION: What We're NOT Doing

❌ **NOT IN SCOPE - REJECTED AS SCOPE CREEP:**
- Performance benchmarking (AC#7 from original) - NOT a coverage requirement
- Coverage dashboard (AC#8 from original) - Nice to have, not required
- Testing all 25 files at 0% - Only safety-critical ones required
- Integration test suite - Separate story, not coverage
- SITL tests - Hardware story (4.7), not coverage

✅ **IN SCOPE - DIRECTLY TRACES TO ACs:**
- Fix 75 failing tests (prerequisite for any coverage work)
- Add tests to reach 80% overall (AC#1)
- Focus on 4 safety-critical files to 90% (AC#2)
- Test 10 API routes to 80% (AC#3)
- Add coverage gates (AC#4)
- Mutation test safety code only (AC#5)

## Sprint 1: Fix Existing Test Suite (PREREQUISITE)

**Justification**: Can't improve coverage with 75 failing tests
**Target**: 828/828 tests passing
**Time**: 4 hours

### Task 1.1: Fix SDR Test Failures (15 tests)
- [ ] Fix test_device_selection_with_args - Mock device list
- [ ] Fix test_unsupported_sample_rate - Validate range check
- [ ] Fix test_shutdown_cleanup - Initialize before cleanup
- [ ] Fix test_configure_device - Mock SoapySDR calls
- [ ] Fix remaining 11 SDR tests - All mock issues

### Task 1.2: Fix Safety Test Failures (10 tests)
- [ ] Fix test_timeout_check - Add timeout_seconds property
- [ ] Fix test_signal_lost - Correct signal loss logic
- [ ] Fix test_battery_exactly_at_threshold - Fix boundary
- [ ] Fix test_geofence_boundary - Fix geometry math
- [ ] Fix remaining 6 safety tests

### Task 1.3: Fix API Test Failures (5 tests)
- [ ] Fix state override API - Return 400 not 500
- [ ] Fix telemetry API assertions
- [ ] Fix config API response codes
- [ ] Fix search API parameters
- [ ] Fix websocket connection test

### Task 1.4: Fix Remaining Tests (45 tests)
- [ ] Fix 9 import errors - Missing mock modules
- [ ] Fix 36 assertion failures - Update expected values

**Validation**: `pytest --tb=short` shows 828 passing, 0 failing

## Sprint 2: Safety-Critical Files to 90% (AC#2)

**Justification**: AC#4 explicitly requires 90% for safety components
**Target**: 4 files from 0% to 90%
**Time**: 6 hours

### Task 2.1: state_machine.py (0% → 90%)
```python
# Required tests (must trace to safety requirements):
- test_idle_to_searching_transition  # HAZARD-001: Unauthorized activation
- test_searching_to_detected         # HAZARD-002: False detection
- test_detected_to_approaching       # HAZARD-003: Unsafe approach
- test_emergency_stop_from_any_state # HAZARD-004: Emergency response
- test_state_timeout_handling        # HAZARD-005: Stuck state
- test_invalid_transition_blocked    # HAZARD-006: Invalid state
```

### Task 2.2: safety.py (0% → 90%)
```python
# Required tests (must trace to safety requirements):
- test_battery_critical_check        # HAZARD-007: Battery failure
- test_geofence_violation_check      # HAZARD-008: Boundary breach
- test_altitude_limit_check          # HAZARD-009: Altitude violation
- test_signal_loss_timeout          # HAZARD-010: Lost signal
- test_emergency_stop_trigger       # HAZARD-011: E-stop failure
```

### Task 2.3: telemetry_recorder.py (0% → 90%)
```python
# Required tests (must trace to safety requirements):
- test_black_box_recording          # HAZARD-012: Data loss
- test_critical_event_logging       # HAZARD-013: Event missing
- test_telemetry_buffer_overflow    # HAZARD-014: Buffer overflow
- test_file_rotation_at_size        # HAZARD-015: Disk full
```

### Task 2.4: waypoint_exporter.py (0% → 90%)
```python
# Required tests (must trace to safety requirements):
- test_waypoint_validation          # HAZARD-016: Invalid waypoint
- test_coordinate_bounds_check      # HAZARD-017: Out of bounds
- test_export_format_validation     # HAZARD-018: Corrupt export
```

**Validation**: `pytest --cov=src.backend.utils.safety --cov-report=term-missing`

## Sprint 3: API Routes to 80% (AC#3)

**Justification**: AC#3 explicitly requires all 10 routes at 80%
**Target**: 10 API files from 0% to 80%
**Time**: 4 hours

### Task 3.1: Core API Routes (5 files)
- [ ] test_system_api.py - GET/POST /api/system/*
- [ ] test_telemetry_api.py - GET /api/telemetry/*
- [ ] test_state_api.py - GET/POST /api/state/*
- [ ] test_config_api.py - GET/PUT /api/config/*
- [ ] test_health_api.py - GET /api/health

### Task 3.2: Feature API Routes (5 files)
- [ ] test_detections_api.py - GET /api/detections/*
- [ ] test_search_api.py - POST /api/search/*
- [ ] test_analytics_api.py - GET /api/analytics/*
- [ ] test_testing_api.py - POST /api/testing/*
- [ ] test_static_api.py - GET /static/*

**Validation**: `pytest tests/backend/api/ --cov=src.backend.api`

## Sprint 4: Close Coverage Gap to 80% (AC#1)

**Justification**: AC#1 requires 80% overall coverage
**Target**: Add 1,346 lines of test coverage
**Time**: 8 hours

### Task 4.1: Calculate Exact Gap
```bash
# Current: 4,827/7,715 = 62.56%
# Target:  6,172/7,715 = 80.00%
# Gap:     1,345 lines need coverage
```

### Task 4.2: Target High-Impact Files
Priority by lines uncovered × criticality:
1. services/mavlink_service.py (142 uncovered, critical)
2. services/signal_processor.py (127 uncovered, critical)
3. services/command_pipeline.py (118 uncovered, critical)
4. services/homing_algorithm.py (95 uncovered, important)
5. Continue until 1,345 lines covered...

**Validation**: `pytest --cov=src.backend --cov-report=html`

## Sprint 5: Coverage Gates & Mutation Testing (AC#4, AC#5)

**Justification**: AC#4 and AC#5 explicitly required
**Target**: Automated enforcement
**Time**: 2 hours

### Task 5.1: Coverage Gates (AC#4)
```yaml
# .github/workflows/test.yml
- name: Check coverage
  run: |
    coverage run -m pytest
    coverage report --fail-under=80
```

### Task 5.2: Mutation Testing Safety Code Only (AC#5)
```bash
# Only on 4 safety-critical files:
mutmut run --paths-to-mutate src/backend/utils/safety.py
mutmut run --paths-to-mutate src/backend/services/state_machine.py
# Target: >75% mutation score
```

**Validation**: PR fails if coverage <80% or mutations survive

## Success Metrics

| Metric | Current | Target | Required |
|--------|---------|--------|----------|
| Overall Coverage | 62.56% | 80% | ✓ |
| Safety Files | 0% | 90% | ✓ |
| API Routes | 0% | 80% | ✓ |
| Failing Tests | 75 | 0 | ✓ |
| Coverage Gates | None | Active | ✓ |
| Mutation Score | N/A | >75% | ✓ |

## What We're NOT Doing (Scope Creep Eliminated)

1. ❌ Performance benchmarking - No AC requires this
2. ❌ Coverage dashboard - No AC requires this
3. ❌ Testing all 25 files at 0% - Only safety-critical required
4. ❌ Integration test suite - Separate concern
5. ❌ SITL tests - Hardware story (4.7)
6. ❌ Hardware mocks - Story 4.7 dependency
7. ❌ Fancy tooling - Just pytest and coverage.py
8. ❌ 100% coverage - 80% is the requirement

## Total Effort

- Sprint 1: 4 hours (fix tests)
- Sprint 2: 6 hours (safety files)
- Sprint 3: 4 hours (API routes)
- Sprint 4: 8 hours (coverage gap)
- Sprint 5: 2 hours (gates)

**Total: 24 hours of focused work**

## Dependencies

- Story 4.7 must provide HAL mocks for hardware-dependent code
- CI/CD pipeline must exist for coverage gates

## Definition of Done

✅ All 828 tests passing
✅ Overall coverage ≥80%
✅ 4 safety files ≥90% coverage
✅ 10 API routes ≥80% coverage
✅ Coverage gates blocking PRs <80%
✅ Mutation score >75% on safety code
❌ No performance benchmarks (not required)
❌ No dashboards (not required)
❌ No integration tests (different story)
