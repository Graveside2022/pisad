# Story 4.4: CI/CD Pipeline & Deployment

## Status

Draft

## Story

**As a** DevOps engineer,  
**I want** automated CI/CD pipelines with proper deployment configuration,  
**So that** code changes are automatically tested and deployable to production.

## Acceptance Criteria

1. CI pipeline runs on every commit with linting, testing, and building
2. Pre-commit hooks configured for Python (ruff/black) and TypeScript (eslint/prettier)
3. Automated testing triggers on pull requests with required checks
4. Code coverage reporting integrated with CI showing trends
5. Production build configuration optimized for performance
6. Deployment service (pisad.service) properly configured for systemd
7. Performance monitoring integrated with deployment pipeline
8. Deployment rollback capability implemented

## Tasks / Subtasks

- [ ] Set up CI/CD pipeline (AC: 1, 3)
  - [ ] Create .github/workflows/ci.yml for GitHub Actions
  - [ ] Configure pipeline to run on push and PR
  - [ ] Add steps for linting, testing, and building
  - [ ] Set up matrix testing for Python 3.11-3.13
  - [ ] Configure caching for dependencies
- [ ] **[CRITICAL] Fix uv.lock and pyproject.toml synchronization issues** (AC: 2)
  - [ ] Resolve dependency conflicts between uv.lock and pyproject.toml
  - [ ] Ensure reproducible builds across environments
  - [ ] Fix any version mismatches that could cause runtime failures
  - [ ] Test clean install works on fresh environment
  - [ ] Document dependency management process
- [ ] Configure pre-commit hooks (AC: 2)
  - [ ] Install pre-commit framework
  - [ ] Configure ruff for Python linting
  - [ ] Configure prettier for TypeScript/React
  - [ ] Add hooks to .pre-commit-config.yaml
  - [ ] Test hooks work on commit
- [ ] Add code coverage reporting (AC: 4)
  - [ ] Configure pytest-cov for backend coverage
  - [ ] Configure jest coverage for frontend
  - [ ] Upload coverage to codecov or similar
  - [ ] Add coverage badges to README
  - [ ] Set minimum coverage thresholds
- [ ] **[CRITICAL] Create production build configuration** (AC: 5)
  - [ ] Optimize Vite build for production (required for Pi 5 deployment)
  - [ ] Configure Python packaging with uv
  - [ ] Minimize bundle sizes for performance requirements
  - [ ] Add build versioning
  - [ ] Test production builds on Pi 5 hardware
  - [ ] Ensure builds meet performance requirements (NFR1-NFR10)
- [ ] **[CRITICAL] Configure deployment service (pisad.service)** (AC: 6)
  - [ ] Update deployment/pisad.service for systemd
  - [ ] Add proper service dependencies
  - [ ] Configure restart policies for deterministic timing
  - [ ] Add logging configuration
  - [ ] Enable auto-start on Pi 5 boot
  - [ ] Test service on Pi hardware
  - [ ] Document deployment procedures
- [ ] **[CRITICAL] Update README with actual setup instructions** (AC: 7)
  - [ ] Write clear installation steps for Pi 5
  - [ ] Document all dependencies and prerequisites
  - [ ] Add configuration instructions
  - [ ] Include troubleshooting section
  - [ ] Ensure single operator can deploy in <15 minutes (NFR10)
  - [ ] Add quick start guide
- [ ] Add performance monitoring (AC: 8)
  - [ ] Integrate basic metrics collection
  - [ ] Add performance benchmarks to CI
  - [ ] Monitor service startup times
  - [ ] Track API response times
  - [ ] Alert on performance degradation

## Dev Notes

### Relevant Architecture Information

**CI/CD Stack** [Source: architecture/tech-stack.md]:
- CI/CD: GitHub Actions
- Python Package Manager: uv (10-100x faster than pip)
- Backend Linting: Ruff 0.8.6
- Build Tool: Vite 7.1.1 with esbuild
- Monitoring: Custom logging + Prometheus 3.5.0 LTS

**GitHub Actions Workflow Structure**:
```yaml
name: CI
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v3
      - uses: astral-sh/setup-uv@v3
      - run: uv sync
      - run: uv run ruff check
      - run: uv run pytest --cov
```

**Pre-commit Configuration** (.pre-commit-config.yaml):
```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.6
    hooks:
      - id: ruff
      - id: ruff-format
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v3.0.0
    hooks:
      - id: prettier
        files: \.(js|jsx|ts|tsx|json|css|md)$
```

**Systemd Service** (deployment/pisad.service):
```ini
[Unit]
Description=PISAD Beacon Detection Service
After=network.target

[Service]
Type=simple
User=pisad
WorkingDirectory=/home/pisad/pisad
ExecStart=/home/pisad/.local/bin/uvx run src/backend/main.py
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**Production Build Optimization**:
- Frontend: Vite with minification and tree-shaking
- Backend: uv with compiled dependencies
- Target bundle size < 5MB for Pi deployment
- Use CDN for large dependencies if needed

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]:
- CI must run all tests in < 10 minutes
- Coverage thresholds: Backend 60%, Frontend 50%
- All PRs must pass CI checks
- Deployment only from main branch
- Rollback procedure must be documented

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation from TODO consolidation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent*

### Debug Log References

*To be populated by Dev Agent*

### Completion Notes List

*To be populated by Dev Agent*

### File List

*To be populated by Dev Agent*

## QA Results

*To be populated by QA Agent*