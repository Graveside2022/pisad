# Story 4.5: API Documentation & Security

## Status

Draft

## Story

**As a** API consumer,
**I want** complete API documentation with proper authentication and validation,
**So that** I can safely integrate with the PISAD system.

## Acceptance Criteria

1. All API endpoints documented with OpenAPI/Swagger specifications
2. Authentication system implemented with JWT tokens
3. Input validation added to all API endpoints with proper error messages
4. API rate limiting implemented to prevent abuse
5. Complete critical API route implementations verified
6. API documentation auto-generated and accessible at /docs endpoint
7. Security headers properly configured (CORS, CSP, etc.)
8. API versioning strategy implemented

## Architectural Notes - Winston (System Architect)

### Code Coverage Context
**IMPORTANT**: The test fixes in this story are primarily for API implementation completeness, not coverage improvement:
- **Current Coverage**: 67% (from Story 4.3) is production-ready
- **Test Fix Impact**: These fixes will improve test pass rate but minimal coverage impact
- **Coverage Ceiling**: Software-only testing limited to ~67-70%
- **Hardware Dependency**: Story 4.7 (Hardware Integration) required for 85%+ coverage
- **Priority Rationale**: These test fixes are lower priority because core functionality is already validated

## Tasks / Subtasks

### [IMMEDIATE ACTION] Phase 1: Fix 60 Failing Tests (3 hours)

**Critical test fixes to reach 67% coverage - Backend exists but needs test repairs**

#### Priority 1: SDR Service Tests (15 failures in test_sdr_service.py)
- [ ] Fix `test_device_selection_with_args` - Mock SDR device discovery properly
- [ ] Fix `test_unsupported_sample_rate` - Correct sample rate validation logic
- [ ] Fix `test_shutdown_cleanup` - Initialize device before cleanup attempt
- [ ] Fix remaining 12 SDR mock initialization issues

#### Priority 2: Safety Interlock Tests (10 failures in test_utils_safety.py)
- [ ] Fix `test_timeout_check` - Add missing timeout_seconds attribute
- [ ] Fix `test_signal_lost` - Correct signal loss detection logic
- [ ] Fix `test_battery_exactly_at_threshold` - Adjust threshold comparison operator
- [ ] Fix `test_geofence` calculations - Correct geometry math for distance
- [ ] Fix `test_set_geofence` - Update method signature
- [ ] Fix `test_update_position` - Correct argument count
- [ ] Fix remaining 4 safety validation tests

#### Priority 3: API Status Code Tests (5 failures)
- [ ] Fix `test_state_override_api.py` - Return 400 for client errors, not 500
- [ ] Fix remaining 4 status code mismatches across API tests

#### Priority 4: Waypoint Export Tests (5 failures in test_waypoint_exporter.py)
- [ ] Fix `test_export_kml_path_generation` - Correct KML coordinate format
- [ ] Fix `test_import_qgc_wpl_invalid_line` - Handle invalid line parsing
- [ ] Fix remaining 3 waypoint format tests

#### Priority 5: Resolve Remaining Tests (25 failures)
- [ ] Fix 9 import errors across various test files
- [ ] Fix 16 misc assertion failures in integration tests

### Test Fixes from Story 4.2 (Lower Priority - Already tracked above)

#### test_state_override_api.py (8/9 passing):

- [ ] Fix 1 test with status code mismatch (returns 400, test expects 500) - API implementation issue

#### test_report_generator.py (9 failures - 7/16 passing):

- [ ] Fix matplotlib backend issues in test environment
- [ ] Mock PDF generation properly to avoid file I/O
- [ ] Fix chart generation tests with proper figure mocking
- [ ] Update report template tests to match current format

#### test_utils_safety.py (13 failures - 38/51 passing):

- [ ] Fix remaining safety check validation tests
- [ ] Update boundary condition tests for safety limits
- [ ] Fix geofence calculation test assertions
- [ ] Verify safety interlock state machine tests

#### test_waypoint_exporter_enhanced.py (2 failures - 24/26 passing):

- [ ] Fix KML export format test
- [ ] Fix waypoint validation edge case test

### [IMMEDIATE ACTION] Phase 2: Document Requirements (30 minutes)

**Document hardware and deployment requirements for field operations**

- [ ] Create `docs/hardware-requirements.md` with:
  - [ ] SDR hardware specifications (RTL-SDR, HackRF, USRP compatibility)
  - [ ] Raspberry Pi 5 setup requirements
  - [ ] MAVLink connection options (serial, UDP, TCP)
  - [ ] Network configuration for web UI access
  - [ ] GPIO pin mappings for status LEDs

- [ ] Update `README.md` with:
  - [ ] Installation prerequisites
  - [ ] Environment variable configuration
  - [ ] Service management commands
  - [ ] Troubleshooting guide
  - [ ] Quick start guide for new deployments

- [ ] Create `config/example-hardware.yaml` template:
  - [ ] SDR configuration examples
  - [ ] MAVLink connection strings
  - [ ] GPIO pin assignments
  - [ ] Performance tuning parameters

### API Implementation Tasks (Already Complete - See Backend Reality Update)

- [x] Complete critical API route implementations (AC: 5) - DONE
  - [ ] Implement system control endpoints in api/routes/system.py
  - [ ] Implement configuration endpoints in api/routes/config.py
  - [ ] Implement mission management in api/routes/missions.py
  - [ ] Add WebSocket message handlers
  - [ ] Test all endpoints with httpx client
- [ ] Document API endpoints (AC: 1, 6)
  - [ ] Add OpenAPI annotations to all routes
  - [ ] Document request/response schemas
  - [ ] Add example requests and responses
  - [ ] Configure auto-generated docs at /docs
  - [ ] Create API usage guide in documentation
- [ ] Implement authentication system (AC: 2)
  - [ ] Add JWT token generation and validation
  - [ ] Create login/logout endpoints
  - [ ] Add authentication middleware
  - [ ] Implement token refresh mechanism
  - [ ] Store API keys securely
- [ ] **[CRITICAL] Add input validation for all API endpoints** (AC: 3)
  - [ ] Define Pydantic schemas for all endpoints (Safety requirement)
  - [ ] Add request validation middleware to prevent crashes
  - [ ] Implement custom validators for complex fields
  - [ ] Return descriptive error messages for invalid inputs
  - [ ] Test validation with invalid inputs to ensure safety
  - [ ] Validate all user inputs to prevent system crashes

## Dev Notes

### Relevant Architecture Information

**API Architecture** [Source: architecture/backend-architecture.md]:

- API routes in `src/backend/api/routes/`
- FastAPI automatic OpenAPI documentation
- Pydantic for request/response validation
- JWT for authentication (local network focus)

**API Route Structure**:

```python
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import Optional

router = APIRouter(prefix="/api/system", tags=["system"])

class SystemCommand(BaseModel):
    command: str
    parameters: Optional[dict] = None

@router.post("/command")
async def execute_command(
    cmd: SystemCommand,
    current_user = Depends(get_current_user)
):
    """Execute a system command"""
    # Implementation
```

**Authentication Requirements** [Source: architecture/tech-stack.md]:

- Simple API key auth for local network
- JWT tokens for session management
- No external auth services required
- Focus on field operations simplicity

**Pydantic Schema Example**:

```python
from pydantic import BaseModel, Field, validator

class MissionConfig(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    search_radius: float = Field(..., gt=0, le=1000)
    beacon_frequency: float = Field(406.025e6)

    @validator('beacon_frequency')
    def validate_frequency(cls, v):
        if v < 406e6 or v > 406.1e6:
            raise ValueError('Frequency must be in 406-406.1 MHz range')
        return v
```

**Critical API Endpoints to Implement**:

- POST /api/system/start - Start mission
- POST /api/system/stop - Stop mission
- GET /api/system/status - Get system status
- GET /api/config - Get configuration
- PUT /api/config - Update configuration
- POST /api/missions - Create mission
- GET /api/missions/{id} - Get mission details
- WS /ws - WebSocket for real-time data

### Testing

**Testing Standards** [Source: architecture/testing-strategy.md]:

- All endpoints must have integration tests
- Test both valid and invalid inputs
- Test authentication and authorization
- Mock external dependencies
- Response time < 100ms for queries

## Change Log

| Date       | Version | Description                                    | Author             |
| ---------- | ------- | ---------------------------------------------- | ------------------ |
| 2025-01-13 | 1.0     | Initial story creation from TODO consolidation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

## Backend Implementation Reality Check - Sentinel (2025-01-15)

### API Implementation Status: 90% COMPLETE

**Current State:**
- ✅ **All API routes implemented** in `/src/backend/api/routes/`
- ✅ **OpenAPI documentation** auto-generated at `/docs`
- ✅ **WebSocket endpoint** fully functional at `/ws`
- ✅ **828 API tests** written (753 passing)

**Existing API Files:**
- `analytics.py` - Analytics endpoints
- `config.py` - Configuration management
- `detections.py` - Detection logging
- `health.py` - Health checks
- `search.py` - Search pattern control
- `state.py` - State management
- `static.py` - Static file serving
- `system.py` - System control
- `telemetry.py` - Telemetry streaming
- `testing.py` - Test result endpoints
- `websocket.py` - Real-time WebSocket

**Updated Tasks (Focus on Fixes, Not Creation):**

### Priority 1: Fix 60 Failing Tests (3 hours)
- [ ] Fix SDR mock initialization (15 tests in `test_sdr_service.py`)
- [ ] Correct safety interlock geometry (10 tests in `test_utils_safety.py`)
- [ ] Fix API status codes (5 tests in `test_state_override_api.py`)
- [ ] Update waypoint export format (5 tests in `test_waypoint_exporter.py`)
- [ ] Resolve remaining test issues (25 tests across various files)

### Priority 2: Complete API Documentation (1 hour)
- [ ] Add missing docstrings to endpoints
- [ ] Update OpenAPI schema annotations
- [ ] Document authentication flow (JWT already configured)
- [ ] Add request/response examples

### Priority 3: Security Hardening (30 mins)
- [ ] Verify CORS configuration
- [ ] Add rate limiting middleware
- [ ] Configure CSP headers
- [ ] Validate all input schemas

**Note:** The confusion about "missing APIs" arose from test failures, not missing implementation. The APIs exist but have minor issues causing test failures.

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
