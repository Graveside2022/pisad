# Story 6.2: Enhanced Homing Algorithm Implementation with ASV

## **ðŸŽ¯ STORY OVERVIEW**

**As a** SAR drone operator,  
**I want** enhanced homing algorithms that provide better course correction when RSSI values degrade,  
**so that** the aircraft can reliably navigate to RF emitters even in challenging signal environments with improved accuracy and recovery capability.

## **âœ… ACCEPTANCE CRITERIA**

1. **Enhanced Course Correction**: Aircraft handles RSSI degradation scenarios with intelligent recovery strategies instead of continuing away from target
2. **Improved Bearing Accuracy**: Â±2Â° precision vs current Â±10Â° through ASV professional-grade bearing calculation algorithms
3. **Signal Confidence Integration**: Course correction decisions based on ASV signal confidence metrics, not just RSSI values
4. **FM Chirp Optimization**: Enhanced processing for narrowband FM chirp signals with interference rejection
5. **Adaptive Search Patterns**: Spiral search and S-turn maneuvers when signal confidence is low
6. **Performance Maintained**: All enhancements achieve <100ms processing latency per PRD-NFR2
7. **Safety Preservation**: All existing safety interlocks maintained with enhanced algorithms

## **ðŸ“‹ ACTIVE TODO TASKS**

**`[ ]`** **`[TASK-6.2.1-COURSE-CORRECTION-ALGORITHM-ENHANCEMENT]`** **Advanced Course Correction Algorithm Implementation** **[Priority: P0]** **[Concurrency: ðŸ”´ SEQUENTIAL]**
- **Hardware:** *HackRF One via USB, existing signal processing chain*
- **Files:** `src/backend/services/homing_algorithm.py`, `src/backend/services/homing_controller.py`, ASV integration layer
- **Dependencies:** Story 6.1 SUBTASK-6.1.2.3 complete (Enhanced course correction algorithm integration)
- **Integration Points:** **VERIFIED** - Existing `HomingAlgorithm` class, `GradientVector` calculation, ASV enhanced bearing algorithms
- **Parallel Development:** **ðŸ”´ SEQUENTIAL** - Requires Story 6.1 ASV integration foundation
- **Prerequisites:** ASV enhanced single-frequency processing operational from Story 6.1
- **Integration Boundary:** N/A (standalone implementation)
- **Resource Conflicts:** File modifications to `homing_algorithm.py` - coordinate with any other homing work
- **Max Developers:** 1 (core algorithm implementation)
- **Subtasks:**
  - **[âœ…]** **SUBTASK-6.2.1.1:** Implement RSSI degradation detection and recovery strategies **[COMPLETED 2025-08-20]**
    - **[âœ…]** **[21a]** Replace basic `np.gradient()` calculation with ASV's professional-grade bearing algorithms
    - **[âœ…]** **[21b]** Implement signal confidence assessment using ASV analyzer confidence metrics
    - **[âœ…]** **[21c]** Create RSSI degradation detection algorithm (trend analysis over time window)
    - **[âœ…]** **[21d]** Add recovery strategy selection based on signal confidence and degradation pattern
  - **[âœ…]** **SUBTASK-6.2.1.2:** Implement adaptive search patterns for low-confidence scenarios **[COMPLETED 2025-08-20]**
    - **[âœ…]** **[22a]** Create spiral search pattern implementation when direct homing confidence < 30%
    - **[âœ…]** **[22b]** Implement S-turn sampling maneuvers for gradient determination in weak signals
    - **[âœ…]** **[22c]** Add return-to-last-peak algorithm when signal completely lost
    - **[âœ…]** **[22d]** Integrate pattern selection logic with existing `HomingSubstage` state machine
  - **[ ]** **SUBTASK-6.2.1.3:** Enhanced signal processing integration with ASV algorithms
    - **[âœ…]** **[23a1]** Update `SignalProcessor` to accept platform velocity from MAVLink telemetry
    - **[âœ…]** **[23a2]** Integrate `DopplerCompensator.compensate_frequency()` in RSSI computation pipeline
    - **[âœ…]** **[23a3]** Add Doppler-compensated frequency tracking to detection events
    - **[âœ…]** **[23a4]** Validate Doppler compensation accuracy with moving platform test scenarios
    - **[âœ…]** **[23b1]** Integrate ASV interference detection from `ASVBearingCalculation.interference_detected` **[COMPLETED 2025-08-20T16:15:00Z]**
    - **[âœ…]** **[23b2]** Add FM chirp signal classification using ASV analyzer signal classification **[COMPLETED 2025-08-20T16:30:00Z]**
    - **[âœ…]** **[23b3]** Implement interference-based confidence weighting in signal strength calculations **[COMPLETED 2025-08-20T16:45:00Z]**
    - **[âœ…]** **[23b4]** Create interference rejection filtering to exclude non-target signals from gradient calculations **[COMPLETED 2025-08-20T17:00:00Z]**
    - **[âœ…]** **[23c1]** Extend `RSSIReading` schema to include signal classification from ASV analyzer **[COMPLETED 2025-08-20T16:30:00Z - included in 23b2]**
    - **[âœ…]** **[23c2]** Implement signal type classification (FM_CHIRP, CONTINUOUS, NOISE, INTERFERENCE) **[COMPLETED 2025-08-20T16:30:00Z - included in 23b2]**
    - **[x]** **[23c3]** Create classification-based filtering for target signal identification âœ… *2025-08-20 12:45*
    - **[x]** **[23c4]** Add signal classification confidence metrics to detection confidence scoring âœ… *2025-08-20 13:00*
    - **[x]** **[23d1]** Implement multi-signal detection tracking in enhanced signal processor âœ… *2025-08-20 13:15*
    - **[ ]** **[23d2]** Create confidence-weighted bearing averaging algorithm for multiple detections
    - **[ ]** **[23d3]** Add bearing fusion conflict resolution when signals from different directions detected
    - **[ ]** **[23d4]** Integrate fused bearing calculations with existing homing gradient computation
- **DoD Task:** Course correction algorithm demonstrably handles RSSI degradation with <2 second recovery time, maintains <100ms processing latency
- **DoD Story:** Complete enhanced homing algorithm operational and tested with real HackRF hardware
- **DoD Epic:** All ASV algorithm enhancements integrated and validated in field testing
- **Context:** Addresses primary operator concern about aircraft course correction when RSSI values decrease
- **PRD Reference:** **PRD-FR4** Navigate toward detected signals using RSSI gradient climbing with enhanced accuracy
- **Progress:** 0%
- **User Approval:** âœ… **APPROVED** 2025-08-20T02:30:00Z

**`[ ]`** **`[TASK-6.2.2-HOMING-CONTROLLER-INTEGRATION]`** **Enhanced Homing Controller with ASV Integration** **[Priority: P1]** **[Concurrency: ðŸŸ¡ CONDITIONAL]**
- **Hardware:** *Cube Red via MAVLink, existing MAVLink service integration*
- **Files:** `src/backend/services/homing_controller.py`, MAVLink velocity command integration
- **Dependencies:** TASK-6.2.1 complete, enhanced course correction algorithms operational
- **Integration Points:** **VERIFIED** - Existing `HomingController`, `MAVLinkService`, `VelocityCommand` interface
- **Parallel Development:** **ðŸŸ¡ CONDITIONAL** - Can start interface design, sequential dependency at MAVLink command integration
- **Prerequisites:** Enhanced course correction algorithms from TASK-6.2.1
- **Integration Boundary:** MAVLink velocity command generation - requires enhanced algorithms from TASK-6.2.1
- **Resource Conflicts:** Modifications to `homing_controller.py` - coordinate with MAVLink integration work
- **Max Developers:** 1 (controller logic implementation)
- **Subtasks:**
  - **[ ]** **SUBTASK-6.2.2.1:** Integrate enhanced algorithms with existing homing controller
    - **[ ]** **[24a1]** Create enhanced algorithm integration interface in `HomingController` class
    - **[ ]** **[24a2]** Replace basic gradient calculation calls with `ASVEnhancedSignalProcessor` API
    - **[ ]** **[24a3]** Update velocity command generation to use enhanced bearing precision
    - **[ ]** **[24a4]** Integrate enhanced confidence metrics into controller decision-making logic
    - **[ ]** **[24b1]** Implement confidence threshold mapping for velocity scaling (0.0-1.0 to velocity multiplier)
    - **[ ]** **[24b2]** Create dynamic velocity scaling algorithm based on signal confidence levels
    - **[ ]** **[24b3]** Add confidence-based approach speed limits (high confidence = faster approach)
    - **[ ]** **[24b4]** Integrate velocity scaling with existing safety velocity constraints
    - **[ ]** **[24c1]** Create adaptive timeout configuration based on signal confidence assessment
    - **[ ]** **[24c2]** Implement confidence-based timeout extension for weak signal scenarios
    - **[ ]** **[24c3]** Add timeout escalation logic when confidence drops below threshold
    - **[ ]** **[24c4]** Integrate adaptive timeouts with existing homing state machine transitions
    - **[ ]** **[24d1]** Update `VelocityCommand` generation to accept enhanced gradient vectors
    - **[ ]** **[24d2]** Integrate enhanced bearing accuracy (Â±2Â°) into command precision calculations
    - **[ ]** **[24d3]** Add confidence-weighted command smoothing to reduce oscillation
    - **[ ]** **[24d4]** Validate enhanced gradient integration maintains <100ms command generation latency
  - **[ ]** **SUBTASK-6.2.2.2:** Safety integration with enhanced algorithms
    - **[ ]** **[25a1]** Validate enhanced algorithm processing times maintain safety interlock response requirements
    - **[ ]** **[25a2]** Create safety response time benchmarking for enhanced algorithm integration
    - **[ ]** **[25a3]** Implement enhanced algorithm timeout detection for safety interlock triggers
    - **[ ]** **[25a4]** Add enhanced algorithm health monitoring to safety system status reporting
    - **[ ]** **[25b1]** Implement confidence-based safety margin scaling (lower confidence = larger margins)
    - **[ ]** **[25b2]** Create confidence threshold validation before aggressive maneuver authorization
    - **[ ]** **[25b3]** Add enhanced algorithm confidence to geofence boundary calculations
    - **[ ]** **[25b4]** Integrate confidence-based safety margins with existing velocity limit enforcement
    - **[ ]** **[25c1]** Create enhanced algorithm health monitoring metrics (processing time, confidence trends)
    - **[ ]** **[25c2]** Implement enhanced algorithm fault detection (stuck confidence, processing timeouts)
    - **[ ]** **[25c3]** Add enhanced algorithm degradation detection and automatic fallback triggers
    - **[ ]** **[25c4]** Integrate enhanced algorithm health status into existing system health monitoring
    - **[ ]** **[25d1]** Validate emergency stop propagation through enhanced algorithm processing pipeline
    - **[ ]** **[25d2]** Ensure enhanced algorithm computations can be interrupted within <500ms requirement
    - **[ ]** **[25d3]** Test emergency stop effectiveness with enhanced algorithms under various confidence levels
    - **[ ]** **[25d4]** Verify enhanced algorithm state cleanup on emergency stop activation
- **DoD Task:** Homing controller successfully integrates enhanced algorithms with existing MAVLink interface, all safety interlocks preserved
- **DoD Story:** Complete enhanced homing system operational with Cube Red integration
- **DoD Epic:** Enhanced homing validated in comprehensive field testing scenarios
- **Context:** Bridges enhanced algorithms from TASK-6.2.1 with existing proven MAVLink flight controller integration
- **PRD Reference:** **PRD-FR15** System ceases velocity commands when flight controller mode changes, **PRD-FR16** Disable Homing control stops commands within 500ms
- **Progress:** 0%
- **User Approval:** âœ… **APPROVED** 2025-08-20T02:30:00Z

**`[ ]`** **`[TASK-6.2.3-D3-WATERFALL-INTEGRATION]`** **Professional-Grade Waterfall Display Integration** **[Priority: P0]** **[Concurrency: ðŸŸ¢ PARALLEL]**
- **Hardware:** *Browser-based UI, existing WebSocket spectrum pipeline*
- **Files:** `WaterfallDisplay.tsx`, `package.json`, spectrum API integration, enhanced signal visualization
- **Dependencies:** Enhanced algorithms from TASK-6.2.1 for signal confidence display integration
- **Integration Points:** **VERIFIED** - Existing WebSocket `/ws/spectrum`, beacon targeting callbacks, signal confidence metrics
- **Parallel Development:** **ðŸŸ¢ PARALLEL** - UI enhancement runs parallel with algorithm development, converges at signal confidence integration
- **Prerequisites:** None (foundational UI improvement)
- **Integration Boundary:** Signal confidence display - enhanced when algorithms complete, functional independently
- **Resource Conflicts:** `WaterfallDisplay.tsx` modifications - coordinate with any other UI work
- **Max Developers:** 1 (frontend waterfall component focus)
- **Library Migration:** **CRITICAL CHANGE** - Replace Plotly.js with d3-waterfall for professional RTL-SDR visualization
- **Subtasks:**
  - **[ ]** **SUBTASK-6.2.3.1:** d3-waterfall library integration and Plotly.js replacement
    - **[ ]** **[28a1]** Remove `plotly.js-dist-min` dependency from package.json and verify bundle size reduction
    - **[ ]** **[28a2]** Remove `react-plotly.js` dependency from package.json and update import statements
    - **[ ]** **[28a3]** Clean up unused Plotly.js type definitions and configuration files
    - **[ ]** **[28a4]** Update TypeScript compiler configuration to remove Plotly.js type dependencies
    - **[ ]** **[28b1]** Install d3-waterfall library with version pinning for stability
    - **[ ]** **[28b2]** Install required d3.js core dependencies for Canvas rendering support
    - **[ ]** **[28b3]** Install d3-waterfall TypeScript definitions for type safety
    - **[ ]** **[28b4]** Verify d3-waterfall installation and basic functionality with minimal test
    - **[ ]** **[28c1]** Create new d3-waterfall component interface replacing react-plotly.js API
    - **[ ]** **[28c2]** Implement d3-waterfall initialization and container management in WaterfallDisplay.tsx
    - **[ ]** **[28c3]** Migrate existing WebSocket spectrum data handling to d3-waterfall format
    - **[ ]** **[28c4]** Refactor beacon targeting click handlers from Plotly.js to d3-waterfall event system
    - **[ ]** **[28d1]** Create WebSocket data format converter for d3-waterfall CSV compatibility
    - **[ ]** **[28d2]** Implement real-time spectrum data streaming to d3-waterfall instance
    - **[ ]** **[28d3]** Optimize WebSocket data format for 3Hz spectrum update performance
    - **[ ]** **[28d4]** Validate WebSocket data conversion maintains frequency/amplitude accuracy
  - **[ ]** **SUBTASK-6.2.3.2:** Enhanced RTL-SDR visualization features implementation
    - **[ ]** **[29a1]** Implement HackRF One native data format support in d3-waterfall configuration
    - **[ ]** **[29a2]** Add RTL-SDR-specific frequency range validation (850MHz - 6.5GHz configurable)
    - **[ ]** **[29a3]** Create bandwidth display optimization for 5MHz operational bandwidth
    - **[ ]** **[29a4]** Integrate RTL-SDR device metadata display (sample rate, gain settings, center frequency)
    - **[ ]** **[29b1]** Install and integrate SIGIDWIKI frequency database for signal identification
    - **[ ]** **[29b2]** Create signal annotation tooltips with frequency identification and characteristics
    - **[ ]** **[29b3]** Implement beacon identification overlay for known signal types
    - **[ ]** **[29b4]** Add signal classification tooltips using ASV analyzer signal type data
    - **[ ]** **[29c1]** Implement d3-waterfall pan controls optimized for professional SAR operation
    - **[ ]** **[29c2]** Add zoom controls with frequency range validation and bandwidth constraints
    - **[ ]** **[29c3]** Create frequency marker system for beacon targeting and reference frequencies
    - **[ ]** **[29c4]** Optimize pan/zoom performance for 5MHz bandwidth real-time display
    - **[ ]** **[29d1]** Implement Canvas-based rendering optimizations for reduced memory usage
    - **[ ]** **[29d2]** Add Canvas animation frame optimization for 3Hz spectrum update synchronization
    - **[ ]** **[29d3]** Create Canvas ImageBitmap caching for improved rendering performance
    - **[ ]** **[29d4]** Validate Canvas rendering performance meets 60fps capability target
  - **[ ]** **SUBTASK-6.2.3.3:** Signal confidence integration with enhanced algorithms
    - **[ ]** **[30a1]** Create signal confidence color overlay system using ASV confidence metrics
    - **[ ]** **[30a2]** Implement confidence-based color scaling (red=low, yellow=medium, green=high confidence)
    - **[ ]** **[30a3]** Add confidence overlay opacity control for signal strength visualization
    - **[ ]** **[30a4]** Integrate real-time confidence updates from enhanced algorithms into color overlay
    - **[ ]** **[30b1]** Implement confidence-based signal highlighting for gradient visualization
    - **[ ]** **[30b2]** Create confidence threshold markers for operator decision support
    - **[ ]** **[30b3]** Add enhanced gradient direction visualization with confidence weighting
    - **[ ]** **[30b4]** Integrate confidence-based beacon targeting validation with visual feedback
    - **[ ]** **[30c1]** Create interference detection visual indicators using ASV rejection data
    - **[ ]** **[30c2]** Implement interference pattern overlay (striped/hatched patterns for interference zones)
    - **[ ]** **[30c3]** Add interference source classification display (FM chirp, continuous, noise)
    - **[ ]** **[30c4]** Integrate real-time interference rejection status into waterfall annotations
    - **[ ]** **[30d1]** Create enhanced algorithm state visualization overlay (spiral search patterns)
    - **[ ]** **[30d2]** Implement S-turn pattern display with sampling trajectory visualization
    - **[ ]** **[30d3]** Add return-to-last-peak pattern display for signal loss recovery
    - **[ ]** **[30d4]** Integrate algorithm state annotations with confidence display for operator awareness
  - **[ ]** **SUBTASK-6.2.3.4:** Testing and validation of d3-waterfall integration
    - **[ ]** **[31a1]** Update WaterfallDisplay.test.tsx to mock d3-waterfall instead of react-plotly.js
    - **[ ]** **[31a2]** Create d3-waterfall component test fixtures with RTL-SDR data simulation
    - **[ ]** **[31a3]** Update integration tests to validate d3-waterfall API compatibility
    - **[ ]** **[31a4]** Add d3-waterfall rendering performance tests with Canvas validation
    - **[ ]** **[31b1]** Validate beacon targeting click handlers work with d3-waterfall event system
    - **[ ]** **[31b2]** Test frequency selection accuracy with d3-waterfall coordinate mapping
    - **[ ]** **[31b3]** Verify beacon targeting integrates correctly with enhanced algorithm confidence
    - **[ ]** **[31b4]** Test beacon targeting under various zoom/pan states and frequency ranges
    - **[ ]** **[31c1]** Create Canvas rendering performance benchmark tests vs Plotly.js baseline
    - **[ ]** **[31c2]** Measure memory usage reduction with Canvas vs DOM-based rendering
    - **[ ]** **[31c3]** Validate 3Hz spectrum update performance with d3-waterfall optimization
    - **[ ]** **[31c4]** Test rendering performance under various spectrum data sizes and update rates
    - **[ ]** **[31d1]** Create mock ASV analyzer data for signal confidence display testing
    - **[ ]** **[31d2]** Validate confidence overlay display accuracy with known confidence values
    - **[ ]** **[31d3]** Test interference detection display with simulated interference patterns
    - **[ ]** **[31d4]** Verify enhanced algorithm state display integration with mock algorithm states
- **DoD Task:** d3-waterfall integrated with professional RTL-SDR features, signal confidence display operational, all existing functionality preserved
- **DoD Story:** Enhanced waterfall display supports operator decision-making for enhanced homing algorithms
- **DoD Epic:** Professional-grade spectrum visualization ready for field testing with enhanced algorithms
- **Context:** **STRATEGIC UI UPGRADE** - Replaces consumer-grade Plotly.js with professional RTL-SDR visualization optimized for SAR operations
- **PRD Reference:** **PRD-UI1** Interactive frequency selection via waterfall, **PRD-UI2** Real-time spectrum visualization with confidence metrics
- **Progress:** 0%
- **User Approval:** âœ… **APPROVED** 2025-08-20T02:30:00Z
- **Bundle Impact:** **POSITIVE** - Reduces bundle size by ~3MB (Plotly.js removal), improves rendering performance 5-10x
- **Migration Note:** **BREAKING CHANGE** - WaterfallDisplay API changes, requires test updates and validation

**`[ ]`** **`[TASK-6.2.4-PERFORMANCE-VALIDATION-AND-TESTING]`** **Enhanced Algorithm Performance Validation** **[Priority: P1]** **[Concurrency: ðŸŸ¡ CONDITIONAL]**
- **Hardware:** *HackRF One, test signal generator, development environment*
- **Files:** Test suite expansion, performance benchmarking, algorithm validation scripts
- **Dependencies:** TASK-6.2.1 and TASK-6.2.2 complete, enhanced homing system operational
- **Integration Points:** **VERIFIED** - Existing test infrastructure, performance monitoring, signal simulation
- **Parallel Development:** **ðŸŸ¡ CONDITIONAL** - Can develop test framework in parallel, sequential dependency on algorithm completion
- **Prerequisites:** Enhanced homing algorithms and controller integration complete
- **Integration Boundary:** Algorithm testing - requires completed enhanced algorithms
- **Resource Conflicts:** HackRF hardware usage for testing - coordinate with development work
- **Max Developers:** 1 (testing and validation focus)
- **Subtasks:**
  - **[ ]** **SUBTASK-6.2.4.1:** Comprehensive algorithm performance testing
    - **[ ]** **[26a1]** Create RSSI degradation test scenarios with controlled signal attenuation
    - **[ ]** **[26a2]** Implement recovery strategy validation tests for spiral search, S-turn, return-to-peak
    - **[ ]** **[26a3]** Create test scenarios for signal confidence degradation and recovery timing
    - **[ ]** **[26a4]** Develop automated test suite for RSSI degradation detection accuracy
    - **[ ]** **[26b1]** Implement automated performance benchmarking framework for enhanced algorithms
    - **[ ]** **[26b2]** Create latency measurement tests for all enhanced algorithm processing stages
    - **[ ]** **[26b3]** Develop <100ms processing latency validation with statistical analysis
    - **[ ]** **[26b4]** Add performance regression testing to ensure no degradation with enhancements
    - **[ ]** **[26c1]** Create controlled signal source test setup for bearing accuracy validation
    - **[ ]** **[26c2]** Implement Â±2Â° bearing precision measurement with known beacon positions
    - **[ ]** **[26c3]** Develop bearing accuracy comparison tests (enhanced vs baseline algorithms)
    - **[ ]** **[26c4]** Create bearing accuracy validation under various signal strength conditions
    - **[ ]** **[26d1]** Create controlled environments for adaptive search pattern effectiveness testing
    - **[ ]** **[26d2]** Implement spiral search pattern validation with success rate measurement
    - **[ ]** **[26d3]** Develop S-turn sampling maneuver effectiveness tests with weak signal scenarios
    - **[ ]** **[26d4]** Create return-to-last-peak algorithm validation with complete signal loss scenarios
  - **[ ]** **SUBTASK-6.2.4.2:** Safety and integration validation
    - **[ ]** **[27a1]** Create safety interlock validation tests with enhanced algorithms active
    - **[ ]** **[27a2]** Implement emergency stop response time testing with enhanced algorithm processing
    - **[ ]** **[27a3]** Develop flight mode change detection tests maintaining <500ms response
    - **[ ]** **[27a4]** Create geofence boundary enforcement tests with enhanced algorithm integration
    - **[ ]** **[27b1]** Implement emergency stop propagation time measurement with enhanced algorithms
    - **[ ]** **[27b2]** Create emergency stop effectiveness tests under various confidence levels
    - **[ ]** **[27b3]** Develop emergency stop interrupt capability tests for enhanced processing pipeline
    - **[ ]** **[27b4]** Validate emergency stop maintains <500ms requirement with all enhancements active
    - **[ ]** **[27c1]** Create PISAD service integration tests with enhanced algorithms operational
    - **[ ]** **[27c2]** Implement enhanced algorithm compatibility tests with existing service interfaces
    - **[ ]** **[27c3]** Develop service communication latency tests with enhanced algorithm overhead
    - **[ ]** **[27c4]** Create service health monitoring validation with enhanced algorithm metrics
    - **[ ]** **[27d1]** Implement performance regression test suite comparing baseline vs enhanced algorithms
    - **[ ]** **[27d2]** Create capability validation tests ensuring no loss of existing functionality
    - **[ ]** **[27d3]** Develop backward compatibility tests for existing homing algorithm interfaces
    - **[ ]** **[27d4]** Create system performance validation ensuring enhanced algorithms don't degrade overall system
- **DoD Task:** All enhanced algorithms meet performance requirements and pass comprehensive testing suite
- **DoD Story:** Enhanced homing system validated and ready for field testing preparation
- **DoD Epic:** Complete enhanced homing system ready for Story 6.4 field validation campaign
- **Context:** Ensures enhanced algorithms meet all PRD requirements before field deployment
- **PRD Reference:** **PRD-NFR2** Signal processing latency shall not exceed 100ms, **PRD-NFR8** 90% successful homing rate once signal is acquired
- **Progress:** 0%
- **User Approval:** âœ… **APPROVED** 2025-08-20T02:30:00Z

## **ðŸ”§ TECHNICAL ARCHITECTURE**

### d3-waterfall Integration Architecture
```typescript
// Professional RTL-SDR Waterfall Display (NEW)
import { Waterfall } from 'd3-waterfall';

interface D3WaterfallDisplayProps {
  centerFreq: number;
  bandwidth: number;
  onSpectrumUpdate?: (data: RTLSDRData) => void;
  onBeaconTargetSet?: (targetFreq: number) => void;
  signalConfidence?: ASVConfidenceData; // NEW: Enhanced algorithm integration
  algorithmState?: HomingAlgorithmState; // NEW: Algorithm state visualization
}

class D3WaterfallDisplay extends React.Component {
  private waterfall: Waterfall;
  private confidenceOverlay: D3ConfidenceOverlay; // NEW: Signal confidence visualization
  
  async componentDidMount() {
    // Initialize d3-waterfall with RTL-SDR optimizations
    this.waterfall = new Waterfall(
      this.containerRef.current,
      null, // Real-time WebSocket data instead of CSV
      'sigidwiki-frequencies.json', // Signal identification database
      true, // Animation enabled for real-time
      true, // Selectable color schemes
      true  // Pan/zoom enabled for professional use
    );
    
    // Enhanced algorithm state integration
    this.confidenceOverlay = new D3ConfidenceOverlay(this.waterfall);
    
    // WebSocket integration for real-time spectrum
    this.initWebSocketIntegration();
  }
  
  // Convert WebSocket FFT data to d3-waterfall format
  private convertWebSocketToD3Format(spectrumData: SpectrumData): RTLSDRRow {
    return {
      timestamp: spectrumData.timestamp,
      frequencies: Array.from(spectrumData.frequencies),
      magnitudes: Array.from(spectrumData.magnitudes),
      confidence: this.props.signalConfidence?.confidence || 1.0 // NEW
    };
  }
  
  // Enhanced beacon targeting with algorithm integration
  private handleWaterfallClick = (freq: number, confidence: number) => {
    // Validate frequency with enhanced algorithm constraints
    if (this.props.algorithmState?.isValidTarget(freq)) {
      this.props.onBeaconTargetSet?.(freq);
    }
  };
}
```

### Signal Confidence Overlay Integration
```typescript
// NEW: Signal confidence visualization for enhanced algorithms
class D3ConfidenceOverlay {
  constructor(private waterfall: Waterfall) {
    this.initConfidenceLayer();
  }
  
  updateConfidenceDisplay(confidence: ASVConfidenceData) {
    // Color-code waterfall based on signal confidence
    const confidenceColorScale = d3.scaleSequential()
      .domain([0, 1])
      .interpolator(d3.interpolateRdYlGn);
    
    // Overlay confidence indicators on waterfall
    this.waterfall.addOverlay('confidence', {
      color: confidenceColorScale(confidence.level),
      opacity: 0.3,
      pattern: confidence.interferenceDetected ? 'striped' : 'solid'
    });
  }
  
  updateAlgorithmState(state: HomingAlgorithmState) {
    // Visualize algorithm state (spiral search, S-turn, etc.)
    switch (state.currentStrategy) {
      case 'SPIRAL_SEARCH':
        this.addSearchPatternOverlay('spiral', state.searchCenter);
        break;
      case 'S_TURN_SAMPLING':
        this.addSearchPatternOverlay('s-turn', state.samplingPath);
        break;
    }
  }
}
```

### Enhanced Homing Algorithm Architecture
```python
# Enhanced Homing Algorithm with ASV Integration
class EnhancedHomingAlgorithm(HomingAlgorithm):
    def __init__(self, asv_analyzer_service: ASVAnalyzerService):
        super().__init__()
        self.asv_analyzer = asv_analyzer_service
        self.signal_confidence_threshold = 0.3  # 30%
        self.rssi_degradation_window = 5  # 5 sample window
        
    async def compute_enhanced_gradient(self, rssi_history: List[RSSISample]) -> EnhancedGradientVector:
        """Compute gradient using ASV professional-grade algorithms."""
        # Replace basic np.gradient with ASV bearing calculation
        bearing_data = await self.asv_analyzer.compute_precise_bearing(rssi_history)
        confidence = await self.asv_analyzer.assess_signal_confidence(rssi_history)
        
        return EnhancedGradientVector(
            magnitude=bearing_data.strength,
            direction=bearing_data.bearing_deg,
            confidence=confidence,
            interference_detected=bearing_data.interference_flag
        )
    
    async def handle_rssi_degradation(self, rssi_trend: RSSITrend) -> RecoveryStrategy:
        """Handle RSSI degradation with intelligent recovery strategies."""
        if rssi_trend.is_degrading and rssi_trend.confidence < self.signal_confidence_threshold:
            if rssi_trend.total_loss:
                return RecoveryStrategy.RETURN_TO_LAST_PEAK
            elif rssi_trend.weak_signal:
                return RecoveryStrategy.SPIRAL_SEARCH
            else:
                return RecoveryStrategy.S_TURN_SAMPLING
        return RecoveryStrategy.CONTINUE_GRADIENT_CLIMB
```

### Signal Confidence Integration
```python
@dataclass
class EnhancedGradientVector(GradientVector):
    """Enhanced gradient vector with ASV confidence metrics."""
    confidence: float  # 0.0-1.0 from ASV signal analysis
    interference_detected: bool  # ASV interference rejection
    signal_classification: str  # ASV signal type classification
    doppler_compensated: bool  # ASV Doppler compensation applied
```

### Recovery Strategy Implementation
```python
class RecoveryStrategy(Enum):
    """Enhanced recovery strategies for challenging signal scenarios."""
    CONTINUE_GRADIENT_CLIMB = "continue_gradient_climb"
    SPIRAL_SEARCH = "spiral_search"  # When confidence < 30%
    S_TURN_SAMPLING = "s_turn_sampling"  # For gradient determination
    RETURN_TO_LAST_PEAK = "return_to_last_peak"  # When signal completely lost
    CONFIDENCE_HOLD = "confidence_hold"  # Hold position until confidence improves
```

## **ðŸ“Š PERFORMANCE IMPROVEMENTS**

### Enhanced Algorithm Performance
| Metric | Current Algorithm | Enhanced with ASV | Improvement |
|--------|------------------|-------------------|-------------|
| **Bearing Accuracy** | Â±10Â° | Â±2Â° | **5x improvement** |
| **RSSI Degradation Recovery** | Continue/Random | Intelligent strategies | **Professional grade** |
| **Signal Confidence** | SNR threshold only | ASV multi-factor analysis | **Comprehensive assessment** |
| **Interference Rejection** | Basic filtering | ASV classification | **Advanced rejection** |
| **Course Correction Speed** | ~2-5 seconds | <2 seconds | **2.5x faster** |
| **Success Rate in Weak Signals** | ~60% | >85% | **40% improvement** |

### Waterfall Display Performance (NEW)
| Metric | Current (Plotly.js) | New (d3-waterfall) | Improvement |
|--------|---------------------|-------------------|-------------|
| **Bundle Size** | 3.2MB (plotly.js-dist-min) | ~200KB (d3-waterfall) | **93% reduction** |
| **Rendering Performance** | DOM-based heatmap | Canvas-based rendering | **5-10x faster** |
| **Memory Usage** | High (DOM elements) | Low (Canvas bitmap) | **70% reduction** |
| **RTL-SDR Integration** | Generic chart library | Native RTL-SDR support | **Purpose-built** |
| **Signal Annotations** | None | SIGIDWIKI integration | **Professional intelligence** |
| **Pan/Zoom Performance** | Sluggish with large data | Optimized ImageBitmap | **Real-time responsive** |
| **Update Rate** | Limited by DOM updates | Canvas animation frames | **60fps capable** |
| **Professional Features** | Basic chart interactions | Signal tooltips, frequency validation | **SAR-operator optimized** |

## **ðŸ”„ DEPENDENCIES AND INTEGRATION**

### Story Dependencies
- **Story 6.1**: ASV foundation and single-frequency enhancement complete
- **Story 6.3**: Mission Planner integration can proceed in parallel
- **Story 6.4**: Field testing requires all enhanced algorithms complete

### Library Migration Dependencies (NEW)
- **REMOVE**: plotly.js-dist-min (^3.1.0) - 3.2MB generic charting library
- **REMOVE**: react-plotly.js (^2.6.0) - React wrapper with performance overhead  
- **ADD**: d3-waterfall (~200KB) - Professional RTL-SDR waterfall library
- **ADD**: d3.js core dependencies for Canvas rendering optimization
- **MODIFY**: WaterfallDisplay.tsx - Complete component refactor required
- **UPDATE**: WaterfallDisplay.test.tsx - Mock library changes and API updates

### Hardware Dependencies
- **HackRF One**: Enhanced processing through existing hardware interface + optimized d3-waterfall RTL-SDR support
- **Cube Red**: MAVLink integration preserved, enhanced telemetry added
- **No Additional Hardware**: All enhancements through software algorithms + professional UI upgrade

### Service Integration Points
- **Preserved**: All existing safety systems and MAVLink communication
- **Enhanced**: Homing algorithm with ASV professional-grade processing
- **Extended**: Signal confidence and interference rejection capabilities
- **Maintained**: 100% backward compatibility with existing PISAD services

## **ðŸŽ¯ SUCCESS CRITERIA**

### Technical Validation
- **Course Correction**: Demonstrable handling of RSSI degradation scenarios
- **Bearing Accuracy**: Â±2Â° precision validated with known signal sources
- **Processing Performance**: <100ms latency maintained with enhanced algorithms
- **Signal Confidence**: Reliable confidence assessment driving course correction decisions
- **Safety Preservation**: All existing safety interlocks maintain <500ms response times
- **Waterfall Performance** (NEW): d3-waterfall renders 3Hz spectrum updates at 60fps with <50ms latency
- **Library Migration** (NEW): Plotly.js completely replaced, bundle size reduced by 3MB, no functionality regression
- **Signal Intelligence** (NEW): SIGIDWIKI signal annotations operational, beacon targeting accuracy improved

### Operational Benefits
- **Improved Success Rate**: >85% successful homing in weak signal conditions
- **Faster Recovery**: <2 second recovery from RSSI degradation scenarios
- **Reduced Oscillation**: Stable approach to targets without overshooting
- **Better Interference Handling**: Professional-grade rejection of non-target signals
- **Enhanced Operator Confidence**: Predictable behavior in challenging RF environments

### Integration Verification
- **Algorithm Compatibility**: Seamless integration with existing homing controller
- **MAVLink Preservation**: All existing velocity command interfaces maintained
- **Safety Compliance**: Enhanced algorithms respect all existing safety mechanisms
- **Performance Validation**: No regression in existing PISAD system performance

---

**Story ID:** `6.2`  
**Epic:** `6 - ASV SDR Framework Integration`  
**Priority:** P0 - Critical enhancement addressing primary operator concern about course correction  
**Dependencies:** Story 6.1 complete (ASV foundation and single-frequency enhancement)  
**Hardware Requirements:** Existing HackRF One + Cube Red setup (no additional hardware)  
**Estimated Total Effort:** 16-24 hours across 2-3 weeks  
**Build Status:** âœ… **READY TO PROCEED** after Story 6.1 completion