# Story 4.7: Hardware Integration Testing

## Status

Ready - Backend framework complete, only hardware integration needed

## Story

**As a** system architect and test engineer,
**I want** to define and integrate actual hardware components for testing,
**So that** we can achieve complete code coverage and validate real-world operation.

## Acceptance Criteria

1. Hardware components selected and documented for Raspberry Pi integration
2. SDR hardware (HackRF One or RTL-SDR) connected and validated
3. Flight controller (Pixhawk or similar) connected via serial/USB
4. Hardware-in-loop (HIL) test environment configured
5. All hardware-dependent code paths tested with real hardware
6. Code coverage increased from 67% to 85%+ with hardware tests
7. Field test procedures documented and executed
8. Performance benchmarks validated with actual hardware

## Tasks / Subtasks

### Phase 1: Hardware Selection and Procurement

- [ ] **Define SDR Hardware Requirements** (AC: 1, 2)
  - [ ] Select between HackRF One ($350) or RTL-SDR v3 ($40) based on budget
  - [ ] Document frequency range requirements (433 MHz, 868 MHz, 915 MHz)
  - [ ] Specify minimum sample rate (2.048 Msps)
  - [ ] Define gain requirements (0-40 dB minimum)
  - [ ] Order selected SDR hardware

- [ ] **Define Flight Controller Requirements** (AC: 1, 3)
  - [ ] Select Pixhawk-compatible flight controller
  - [ ] Document MAVLink protocol version requirements (v2.0)
  - [ ] Specify serial connection parameters (115200 baud)
  - [ ] Define telemetry radio requirements if needed
  - [ ] Order flight controller and cables

- [ ] **Define Raspberry Pi Configuration** (AC: 1)
  - [ ] Confirm Raspberry Pi 5 (8GB) as target platform
  - [ ] Document GPIO pin assignments for status LEDs
  - [ ] Specify power requirements (5V 5A minimum)
  - [ ] Define cooling requirements (active cooling for SDR operation)
  - [ ] Document SD card requirements (64GB minimum, Class 10)

### [IMMEDIATE ACTION] Phase 2A: Create Hardware Configuration (1 hour)

**Create configuration files for hardware integration**

- [ ] **Create `config/hardware.yaml`** with production settings:
  ```yaml
  sdr:
    device: "rtlsdr"  # Options: rtlsdr, hackrf, usrp
    frequency: 433920000  # 433.92 MHz
    sample_rate: 2048000  # 2.048 Msps
    gain: 30  # 0-40 dB range
    device_args: ""  # Additional device arguments

  mavlink:
    connection: "serial:///dev/ttyAMA0:921600"  # Pi serial
    # Alternative: "udp:127.0.0.1:14550" for SITL
    # Alternative: "tcp:192.168.1.100:5760" for network
    heartbeat_rate: 1  # Hz
    timeout: 10  # seconds

  gpio:
    status_led: 17  # Green LED - BCM pin 17
    error_led: 27   # Red LED - BCM pin 27
    ready_led: 22   # Blue LED - BCM pin 22
    buzzer: 23      # Optional buzzer

  performance:
    rssi_update_rate: 10  # Hz
    telemetry_rate: 5     # Hz
    log_level: "INFO"
    max_memory_mb: 512
  ```

- [ ] **Create hardware mock configuration** `config/hardware-mock.yaml`:
  - [ ] Mock SDR settings for testing without hardware
  - [ ] SITL connection string for MAVLink
  - [ ] Virtual GPIO pins for simulation

- [ ] **Update configuration loading** in `src/backend/core/config.py`:
  - [ ] Load hardware.yaml on startup
  - [ ] Fall back to hardware-mock.yaml if hardware not found
  - [ ] Validate all hardware parameters
  - [ ] Log configuration being used

### Phase 2B: Hardware Integration (Original Phase 2)

- [ ] **SDR Hardware Integration** (AC: 2)
  - [ ] Connect SDR to Raspberry Pi USB 3.0 port
  - [ ] Install SoapySDR drivers for selected hardware
  - [ ] Validate device enumeration and identification
  - [ ] Test frequency tuning across full range
  - [ ] Calibrate gain settings for optimal SNR
  - [ ] Measure actual noise floor with hardware
  - [ ] Test streaming stability at 2.048 Msps

- [ ] **Flight Controller Integration** (AC: 3)
  - [ ] Connect Pixhawk via USB or serial to Pi
  - [ ] Configure serial port permissions (dialout group)
  - [ ] Test MAVLink heartbeat reception
  - [ ] Validate telemetry data stream
  - [ ] Test command sending (arm/disarm)
  - [ ] Verify GPS data reception
  - [ ] Test mission upload/download

- [ ] **System Integration** (AC: 4)
  - [ ] Configure systemd service for automatic startup
  - [ ] Test power-on initialization sequence
  - [ ] Validate service recovery after hardware disconnect
  - [ ] Test USB hot-plug scenarios
  - [ ] Measure actual startup time with hardware
  - [ ] Test emergency stop with hardware in loop

### Phase 3: Hardware Test Coverage

- [ ] **SDR Coverage Tests** (AC: 5, 6)
  - [ ] Test SDR calibration routine (adds ~5% coverage)
  - [ ] Test hardware-specific error paths
  - [ ] Test temperature sensor reading
  - [ ] Test frequency range validation
  - [ ] Test sample rate stability monitoring
  - [ ] Test gain optimization algorithm
  - [ ] Test streaming error recovery

- [ ] **MAVLink Coverage Tests** (AC: 5, 6)
  - [ ] Test SITL integration
  - [ ] Test real flight controller communication
  - [ ] Test mission management with hardware
  - [ ] Test telemetry streaming performance
  - [ ] Test command acknowledgment handling
  - [ ] Test connection loss and recovery
  - [ ] Test parameter reading/writing

- [ ] **Integration Coverage Tests** (AC: 5, 6)
  - [ ] Test complete signal detection pipeline
  - [ ] Test state transitions with real RSSI data
  - [ ] Test homing commands to flight controller
  - [ ] Test geofence enforcement with GPS
  - [ ] Test emergency stop with motors armed
  - [ ] Test complete mission execution

### Phase 4: Field Testing

- [ ] **Lab Testing** (AC: 7)
  - [ ] Set up beacon transmitter at known location
  - [ ] Test detection at various distances (10m, 50m, 100m)
  - [ ] Measure detection sensitivity and range
  - [ ] Test in RF-noisy environment
  - [ ] Document false positive rate
  - [ ] Validate bearing calculation accuracy

- [ ] **Field Testing** (AC: 7, 8)
  - [ ] Create field test checklist
  - [ ] Select safe test location (open field)
  - [ ] Test with drone on ground first
  - [ ] Test hovering detection
  - [ ] Test approach patterns
  - [ ] Measure actual homing accuracy
  - [ ] Document environmental factors

- [ ] **Performance Validation** (AC: 8)
  - [ ] Measure actual CPU usage with hardware
  - [ ] Test memory consumption under load
  - [ ] Validate <10s startup with hardware
  - [ ] Test sustained operation (1+ hour)
  - [ ] Measure battery consumption
  - [ ] Test thermal performance
  - [ ] Document maximum detection range

## Hardware Budget Estimate

| Component | Option 1 (Budget) | Option 2 (Professional) |
|-----------|------------------|------------------------|
| SDR | RTL-SDR v3 ($40) | HackRF One ($350) |
| Flight Controller | Pixhawk 4 Mini ($200) | Pixhawk 6C ($400) |
| Telemetry Radio | SiK Radio v3 ($80) | RFD900x ($250) |
| Test Beacon | DIY ESP32 ($20) | Professional ($200) |
| Cables & Accessories | $50 | $100 |
| **Total** | **$390** | **$1,300** |

## Dependencies

- Story 4.3 must be complete (service integration)
- Story 4.4 CI/CD should be complete for automated hardware tests
- Physical access to Raspberry Pi 5 required
- Safe testing location required for field tests

## Risks

1. **Hardware Availability**: Lead time for components may delay testing
2. **Hardware Compatibility**: Selected hardware may have driver issues on Pi
3. **RF Regulations**: Must ensure compliance with local RF regulations
4. **Safety**: Field testing with drone requires appropriate safety measures
5. **Weather**: Field testing dependent on weather conditions

## Success Metrics

- Code coverage increases from 67% to 85%+
- All hardware-dependent code paths tested
- Zero hardware-related crashes in 1-hour stress test
- Detection range meets or exceeds 500m requirement
- False positive rate remains below 5% with real hardware
- Complete mission execution from detection to holding

## Mock/Simulated/Hardcoded Values Inventory

### CRITICAL: Complete inventory of all mock, fake, simulated, and hardcoded values that must be replaced with real hardware integration

#### 1. Beacon Simulator Service (`src/backend/services/beacon_simulator.py`)
**Purpose**: Complete RF beacon simulation for testing without physical beacons
**Mock/Simulated Elements**:
- Line 47-50: **HARDCODED** noise floor: `-110.0` dBm
- Line 48-50: **HARDCODED** propagation factor: `2.0` (free space path loss)
- Line 49-50: **HARDCODED** reference distance: `1.0` meter, loss: `40.0` dB
- Line 238: **SIMULATED** Gaussian noise: `random.gauss(0, 2)`
- Line 289: **PLACEHOLDER** receiver position: `(0, 0, 0)` - needs real GPS
- Line 210-252: **SIMULATED** RSSI calculation using path loss model
- Line 269-274: **SIMPLIFIED** distance calculation - needs haversine for GPS

#### 2. SDR Service (`src/backend/services/sdr_service.py`)
**Current State**: Attempts real hardware but has fallbacks
**Mock/Fallback Elements**:
- Line 83-85: Returns empty list `[]` when SoapySDR unavailable
- Line 139-142: Sets status to `"UNAVAILABLE"` when no SoapySDR
- Line 110-111: Raises `SDRNotFoundError` when no devices found
- **NO MOCK DATA GENERATION** - service fails gracefully without hardware

#### 3. MAVLink Service (`src/backend/services/mavlink_service.py`)
**Current State**: Attempts real connection but initializes with defaults
**Hardcoded/Default Elements**:
- Line 37: **DEFAULT** device path: `/dev/ttyACM0`
- Line 38: **DEFAULT** baud rate: `115200`
- Line 39-42: **DEFAULT** system/component IDs: `1, 191, 1, 1`
- Line 75: **HARDCODED** heartbeat timeout: `3.0` seconds
- Line 79-80: **HARDCODED** reconnect delays: `1.0` to `30.0` seconds
- Line 83-90: **INITIALIZED** telemetry with zeros/defaults:
  - Position: `lat=0.0, lon=0.0, alt=0.0`
  - Attitude: `roll=0.0, pitch=0.0, yaw=0.0`
  - Battery: `voltage=0.0, current=0.0, percentage=0.0`
  - GPS: `fix_type=0, satellites=0, hdop=0.0`
  - Flight mode: `"UNKNOWN"`
  - Armed: `False`
- Line 95-96: **HARDCODED** velocity limits: `0.1` sec rate, `5.0` m/s max
- Line 115: **DEFAULT** RSSI: `-100.0` dBm (noise floor)

#### 4. Signal Processor (`src/backend/services/signal_processor.py`)
**Hardcoded/Default Values**:
- Line 27: **DEFAULT** EWMA alpha: `0.3` (smoothing factor)
- Line 63-67: **DEFAULT** processing parameters:
  - FFT size: `1024`
  - SNR threshold: `12.0` dB
  - Noise window: `1.0` second
  - Sample rate: `2.048e6` Hz (2.048 MHz)
- Line 90: **INITIALIZED** noise floor: `-100.0` dBm
- Line 102: **HARDCODED** calibration offset: `-30.0` dBm (needs hardware calibration)
- Line 109: **DEFAULT** RSSI: `-100.0` dBm
- Line 159: **DEFAULT** RSSI rate: `2.0` Hz
- Line 207: **HARDCODED** floor value: `-120.0` dBm for zero power
- Line 269: **HARDCODED** minimum history: `10` samples for noise estimation

#### 5. Dependencies Service (`src/backend/core/dependencies.py`)
**Mock/Fallback Logic**:
- Line 56-63: **FALLBACK** logic for SDR initialization failure
- Service manager attempts real hardware but continues with degraded mode
- No explicit mock services - relies on service internal fallbacks

#### 6. Configuration File (`config/default.yaml`)
**Hardcoded Default Values**:
- Line 12: **DEFAULT** SDR frequency: `433920000` Hz (433.92 MHz)
- Line 13: **DEFAULT** SDR sample rate: `2048000` Hz (2.048 MHz)
- Line 14: **DEFAULT** SDR gain: `30` dB
- Line 15: **DEFAULT** PPM correction: `0`
- Line 17: **DEFAULT** buffer size: `16384`
- Line 20: **DEFAULT** RSSI threshold: `-70` dBm
- Line 21: **DEFAULT** averaging window: `10` samples
- Line 22-23: **DEFAULT** signal timing: `100` ms duration, `50` ms gap
- Line 51: **HARDCODED** max velocity: `2.0` m/s (safety)
- Line 76: **FLAG** `DEV_MOCK_SDR: false` - mock SDR toggle (NOT IMPLEMENTED)
- Line 79-90: **HARDCODED** homing algorithm parameters:
  - Forward velocity max: `5.0` m/s
  - Yaw rate max: `0.5` rad/s
  - Approach velocity: `1.0` m/s
  - Signal loss timeout: `5.0` seconds
  - Gradient window: `10` samples
  - Min SNR: `10.0` dB
  - Approach threshold: `-50.0` dBm
  - Plateau variance: `2.0`
  - Velocity scale: `0.1`

#### 7. State Machine (`src/backend/services/state_machine.py`)
**Hardcoded Values to Check**:
- State transition timeouts
- Default search patterns
- Safety limits

#### 8. Signal State Controller (`src/backend/services/signal_state_controller.py`)
**Hardcoded Thresholds (from Story 4.3)**:
- Line 60-61: **HARDCODED** trigger threshold: `12.0` dB
- Line 60-61: **HARDCODED** drop threshold: `6.0` dB
- Line 62-63: **HARDCODED** timing: `0.5` sec confirmation, `1.0` sec drop
- Line 64-65: **HARDCODED** anomaly detection: window `100`, threshold `3.0` Z-score

#### 9. Command Pipeline (`src/backend/services/command_pipeline.py`)
**Hardcoded Safety Limits**:
- Line 121: **HARDCODED** rate limit: `10.0` commands/sec
- Line 332: **HARDCODED** max altitude: `500` meters
- Line 346: **HARDCODED** max velocity: `20.0` m/s
- Line 384: **HARDCODED** takeoff altitude range: `1-100` meters

### Hardware Integration Requirements

#### SDR Hardware Integration Points:
1. **Replace**: Empty device list with actual SoapySDR enumeration
2. **Implement**: Real IQ sample streaming from hardware
3. **Calibrate**: Actual noise floor measurement
4. **Configure**: Hardware-specific gain/frequency settings
5. **Monitor**: Real temperature sensors

#### MAVLink Hardware Integration Points:
1. **Replace**: Default telemetry values with real flight controller data
2. **Connect**: Actual serial/USB connection to Pixhawk
3. **Stream**: Real GPS coordinates, battery status, attitude
4. **Execute**: Actual flight commands (arm, takeoff, land)
5. **Monitor**: Real heartbeat and connection status

#### Beacon Hardware Integration Points:
1. **Replace**: Entire beacon simulator with real beacon detection
2. **Implement**: Real RSSI measurements from SDR
3. **Calculate**: Actual signal propagation and multipath
4. **Remove**: Synthetic noise generation
5. **GPS**: Real receiver position from flight controller

### Critical Integration Priority:

1. **HIGHEST PRIORITY**: MAVLink telemetry (Line 83-90) - Safety critical
2. **HIGH**: SDR device detection and streaming
3. **HIGH**: Remove beacon simulator for real beacon
4. **MEDIUM**: Replace hardcoded thresholds with calibrated values
5. **LOW**: Optimize default configurations

### Summary of Mock/Simulated Infrastructure

#### Current State:
1. **NO EXPLICIT MOCK SERVICES**: The codebase does NOT have dedicated MockSDRService or MockMAVLinkService classes
2. **BEACON SIMULATOR**: The primary simulation infrastructure is the beacon_simulator.py service
3. **GRACEFUL DEGRADATION**: Services attempt real hardware and fail gracefully if unavailable
4. **HARDCODED DEFAULTS**: Extensive use of default values that work without hardware

#### Key Findings:
- **Total Hardcoded Values**: ~50+ configuration parameters and thresholds
- **Simulated Components**: Only beacon_simulator provides full simulation
- **Missing Mock Layer**: No proper mock service implementations for testing
- **Hardware Assumptions**: Code assumes hardware will provide real data

#### Critical Replacements Needed:
1. **Remove beacon_simulator.py entirely** when real beacon available
2. **Replace MAVLink telemetry defaults** (Line 83-90) with real GPS/attitude
3. **Calibrate signal processor offset** (Line 102: -30.0 dBm)
4. **Measure actual noise floor** (replace -100.0 dBm defaults)
5. **Configure hardware-specific parameters** in config/default.yaml

### Testing Strategy for Hardware:

```python
# Environment variable to switch between mock and real
if os.environ.get("USE_REAL_HARDWARE"):
    # Real hardware initialization
    sdr = SDRService()  # Will connect to actual SDR
    mavlink = MAVLinkService("/dev/ttyACM0")  # Real Pixhawk
    # DO NOT USE beacon_simulator - use real beacon
else:
    # Current fallback (needs improvement)
    sdr = SDRService()  # Will fail gracefully without hardware
    mavlink = MAVLinkService()  # Will use default telemetry
    # beacon_simulator provides simulated signals
```

### Recommended Implementation Order:
1. **Phase 1**: Connect real SDR, remove beacon simulator
2. **Phase 2**: Connect Pixhawk, replace telemetry defaults
3. **Phase 3**: Calibrate all thresholds with real measurements
4. **Phase 4**: Create proper MockService classes for CI/CD

## Dev Notes

### Relevant Architecture Information

**Hardware Abstraction Layer** [Source: 4.3.story.md]:
- SDR service already has mock fallback
- MAVLink service has auto-reconnection
- Service manager handles hardware initialization failures gracefully

**Current Coverage Gaps** [Source: 4.3.story.md Test Report]:
- SDR calibration routine: 210 lines uncovered
- MAVLink mission management: 104 lines uncovered
- Hardware sensor readings: ~50 lines uncovered
- Hardware error paths: ~100 lines uncovered

**Testing Strategy**:
```python
# Hardware test fixture example
@pytest.fixture
def real_sdr():
    """Fixture that only runs with real hardware."""
    if not os.environ.get("HARDWARE_TESTS"):
        pytest.skip("Hardware tests disabled")

    sdr = SDRService()
    sdr.initialize()
    yield sdr
    sdr.stop()
```

## Change Log

| Date       | Version | Description | Author |
|------------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation for hardware integration testing | Winston (Architect) |
| 2025-01-15 | 1.1 | Updated with backend reality - framework exists, hardware needed | Sentinel |

## Backend Reality Update - Sentinel (2025-01-15)

### Backend Framework Status: COMPLETE

**What's Already Implemented:**
- ✅ SDR Service (`src/backend/services/sdr_service.py`) - Complete with mock support
- ✅ MAVLink Service (`src/backend/services/mavlink_service.py`) - Full implementation
- ✅ Signal Processor (`src/backend/services/signal_processor.py`) - RSSI/SNR analysis
- ✅ Hardware abstraction layer - Ready for real hardware

**What This Story Actually Needs:**
1. **Hardware Configuration File** (`config/hardware.yaml`):
   ```yaml
   sdr:
     device: "rtlsdr"  # or "hackrf", "usrp"
     frequency: 433920000
     sample_rate: 2048000
     gain: 30

   mavlink:
     connection: "serial:///dev/ttyAMA0:921600"
     # or "udp:127.0.0.1:14550"

   gpio:
     status_led: 17
     error_led: 27
     ready_led: 22
   ```

2. **Hardware Mock Improvements** (for testing without hardware):
   - Better SDR device simulation
   - MAVLink SITL integration
   - GPIO pin simulation

3. **Deployment Service** (`deployment/pisad.service`):
   ```ini
   [Unit]
   Description=PISAD RF Beacon Detection Service
   After=network.target

   [Service]
   Type=simple
   User=pisad
   WorkingDirectory=/home/pisad/projects/pisad
   ExecStart=/home/pisad/.local/bin/uv run uvicorn src.backend.core.app:app --host 0.0.0.0 --port 8080
   Restart=on-failure
   RestartSec=5

   [Install]
   WantedBy=multi-user.target
   ```

**Coverage Impact:**
- Current: 62.56% (software only)
- After hardware mocks: 67%
- With real hardware: 85%+

## Acceptance Testing Checklist

- [ ] SDR hardware detected and initialized
- [ ] Flight controller connected and responding
- [ ] Complete signal detection pipeline tested
- [ ] Mission execution tested end-to-end
- [ ] Code coverage report shows 85%+
- [ ] Field test report completed
- [ ] Performance benchmarks documented
- [ ] Hardware configuration guide created
