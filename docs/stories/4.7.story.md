# Story 4.7: Hardware Integration Testing

## Status

In Progress - Hardware connected and HAL implemented, integration testing needed

## Story

**As a** system architect and test engineer,
**I want** to define and integrate actual hardware components for testing,
**So that** we can achieve complete code coverage and validate real-world operation.

## Acceptance Criteria

1. Hardware components selected and documented for Raspberry Pi integration
2. SDR hardware (HackRF One or RTL-SDR) connected and validated
3. Flight controller (Pixhawk or similar) connected via serial/USB
4. Hardware-in-loop (HIL) test environment configured
5. All hardware-dependent code paths tested with real hardware
6. Code coverage increased from 67% to 85%+ with hardware tests
7. Field test procedures documented and executed
8. Performance benchmarks validated with actual hardware

## Tasks / Subtasks

### Sprint 1: Hardware Configuration Complete ✅

- [x] **SDR Hardware Configured** (AC: 1, 2) ✅ COMPLETE
  - [x] ~~RTL-SDR v3 eliminated - cannot reach 3.2 GHz~~
  - [x] HackRF One selected and connected (USB Bus 003 Device 003)
  - [x] Frequency range: 850 MHz - 6.5 GHz (software configurable)
  - [x] Sample rate: 20 Msps for 5 MHz bandwidth
  - [x] Gain control: LNA 0-40 dB (8dB steps), VGA 0-62 dB (2dB steps)
  - [x] pyhackrf library installed via uv (v0.2.0)

- [x] **Flight Controller Connected** (AC: 1, 3) ✅ COMPLETE
  - [x] Flight controller: Pixhawk 4 with Cube Orange+ (connected)
  - [x] MAVLink protocol: v1.0 and v2.0 via pymavlink v2.4.49
  - [x] Serial connection: /dev/ttyACM0 (primary), /dev/ttyACM1 (secondary)
  - [x] Baud rate: 115200 bps confirmed
  - [x] USB connection verified via dmesg

- [x] **System Configuration** (AC: 1) ✅ COMPLETE
  - [x] Raspberry Pi 5 (8GB) confirmed as platform
  - [x] No GPIO LEDs required (per user specification)
  - [x] Log-periodic antenna: 850 MHz - 6500 MHz directional
  - [x] Software beacon generation for testing only
  - [x] Auto-detection system specified

### [IMMEDIATE ACTION] Sprint 2: HAL Implementation & Testing (4 hours)

- [x] **HAL Implementation Complete** (AC: 2, 3) ✅ DONE
  - [x] Created src/backend/hal/hackrf_interface.py with pyhackrf
  - [x] Created src/backend/hal/mavlink_interface.py with pymavlink
  - [x] Implemented complex float32 IQ sample streaming
  - [x] Implemented NED velocity commands for Cube Orange+
  - [x] Added auto-detection functions for both devices

- [ ] **Software Beacon Generator** (AC: 2, 5)
  - [ ] Create src/backend/hal/beacon_generator.py
  - [ ] Generate FM pulse signal at configurable frequency
  - [ ] Implement radar-like pulse patterns
  - [ ] Add frequency hopping capability (850 MHz - 6.5 GHz)
  - [ ] Create YAML configuration for beacon parameters

- [ ] **Hardware Auto-Detection Service** (AC: 1, 6)
  - [ ] Create src/backend/services/hardware_detector.py
  - [ ] Implement startup auto-detection for HackRF
  - [ ] Implement startup auto-detection for Cube Orange+
  - [ ] Add retry logic with exponential backoff
  - [ ] Graceful degradation if hardware unavailable

- [ ] **Real-Time Performance Metrics** (AC: 6, 8)
  - [ ] Create src/backend/services/performance_monitor.py
  - [ ] Implement CPU/RAM monitoring via psutil
  - [ ] Add SDR sample rate and drop monitoring
  - [ ] Track MAVLink latency and packet loss
  - [ ] Create WebSocket endpoint for real-time metrics

- [ ] **Hardware Integration Testing** (AC: 7)
  - [ ] Test HackRF connection and streaming
  - [ ] Test Cube Orange+ MAVLink communication
  - [ ] Verify auto-detection on system startup
  - [ ] Measure actual USB throughput
  - [ ] Document any hardware-specific issues

### Sprint 3: Configuration & Integration

- [ ] **Create `config/hardware.yaml`** with production settings:
  ```yaml
  sdr:
    device: "hackrf"  # Primary device
    frequency: 3200000000  # 3.2 GHz default
    sample_rate: 20000000  # 20 Msps
    lna_gain: 16  # 0-40 dB in 8dB steps
    vga_gain: 20  # 0-62 dB in 2dB steps
    amp_enable: false  # RF amplifier
    antenna: "log_periodic"  # 850 MHz - 6.5 GHz

  mavlink:
    connection: "serial:///dev/ttyACM0:115200"  # Cube Orange+ primary
    fallback: "serial:///dev/ttyACM1:115200"  # Cube Orange+ secondary
    heartbeat_rate: 1  # Hz
    timeout: 10  # seconds
    system_id: 255
    component_id: 190

  beacon:
    mode: "software"  # software or hardware
    frequency_min: 850000000  # 850 MHz
    frequency_max: 6500000000  # 6.5 GHz
    pulse_width: 0.001  # 1ms
    pulse_period: 0.1  # 100ms PRF=10Hz

  performance:
    rssi_update_rate: 1  # Hz (power efficient)
    telemetry_rate: 4     # Hz
    log_level: "INFO"
    max_memory_mb: 512
    cpu_target: 30  # Target CPU usage %
  ```

- [ ] **Create hardware mock configuration** `config/hardware-mock.yaml`:
  - [ ] Mock SDR settings for testing without hardware
  - [ ] SITL connection string for MAVLink
  - [ ] Virtual GPIO pins for simulation

- [ ] **Update configuration loading** in `src/backend/core/config.py`:
  - [ ] Load hardware.yaml on startup
  - [ ] Fall back to hardware-mock.yaml if hardware not found
  - [ ] Validate all hardware parameters
  - [ ] Log configuration being used

- [ ] **System Integration** (AC: 4)
  - [ ] Configure systemd service for automatic startup
  - [ ] Test power-on initialization sequence
  - [ ] Validate service recovery after hardware disconnect
  - [ ] Test USB hot-plug scenarios
  - [ ] Measure actual startup time with hardware
  - [ ] Test emergency stop with hardware in loop

### Sprint 4: Hardware Test Coverage & Validation

- [ ] **SDR Coverage Tests** (AC: 5, 6)
  - [ ] Test HackRF frequency tuning 850 MHz - 6.5 GHz
  - [ ] Test 20 Msps sample rate with pyhackrf
  - [ ] Test 1 Hz batch processing efficiency
  - [ ] Test USB 2.0 throughput (sufficient for HackRF)
  - [ ] Test LNA gain 0-40 dB (8dB steps)
  - [ ] Test VGA gain 0-62 dB (2dB steps)
  - [ ] Test software beacon generation

- [ ] **MAVLink Coverage Tests** (AC: 5, 6)
  - [ ] Test Cube Orange+ on /dev/ttyACM0
  - [ ] Test 115200 baud communication
  - [ ] Test pymavlink v2.4.49 integration
  - [ ] Test 10-second heartbeat timeout
  - [ ] Test NED velocity commands
  - [ ] Test RC override detection (±50 PWM)
  - [ ] Test battery monitoring (6S Li-ion)

- [ ] **Timing Validation Tests** (AC: 6, 8)
  - [ ] Verify mode change detection <100ms
  - [ ] Verify emergency stop response <500ms
  - [ ] Validate 1 Hz RSSI processing efficiency
  - [ ] Measure Pi 5 CPU usage at 1 Hz (target <30%)
  - [ ] Test state machine at 10 Hz update rate
  - [ ] Confirm WebSocket updates at 1 Hz

- [ ] **Integration Coverage Tests** (AC: 5, 6)
  - [ ] Test complete signal detection pipeline
  - [ ] Test state transitions with real RSSI data
  - [ ] Test homing commands to flight controller
  - [ ] Test geofence enforcement with GPS
  - [ ] Test emergency stop with motors armed
  - [ ] Test complete mission execution

### Sprint 5: Field Testing & Safety Validation

- [ ] **Hardware Integration Testing** (AC: 7)
  - [ ] Verify HackRF on USB Bus 003
  - [ ] Verify Cube Orange+ on /dev/ttyACM0
  - [ ] Test log-periodic antenna performance
  - [ ] Test software beacon at various frequencies
  - [ ] Measure detection range with directional antenna
  - [ ] Document performance across 850 MHz - 6.5 GHz

- [ ] **Safety System Validation** (AC: 5, 7)
  - [ ] Test 6S Li-ion battery monitoring (19.2V low, 18.0V critical)
  - [ ] Verify GPS requirements (8 sats, HDOP < 2.0) via Here4
  - [ ] Test ArduPilot geofence via Mission Planner
  - [ ] Validate signal loss → SEARCHING state transition
  - [ ] Test RC stick movement override (±50 PWM)
  - [ ] Verify mode change from GUIDED → IDLE

- [ ] **Field Testing with Drone** (AC: 7, 8)
  - [ ] Pre-flight hardware auto-detection check
  - [ ] Ground test all safety interlocks
  - [ ] Software beacon detection test
  - [ ] Frequency agility test (850 MHz - 6.5 GHz)
  - [ ] RC override response test
  - [ ] Real-time performance metrics validation

- [ ] **Performance Validation** (AC: 8)
  - [ ] CPU usage at 1 Hz processing (<30% target)
  - [ ] RAM usage (<500MB target)
  - [ ] HackRF USB 2.0 throughput
  - [ ] MAVLink latency (<50ms target)
  - [ ] Directional antenna gain validation
  - [ ] Battery consumption with all systems active

## Hardware Configuration (Actual)

| Component | Selected Hardware | Status |
|-----------|------------------|---------|
| SDR | HackRF One ($350) | ✅ Connected (USB Bus 003) |
| Flight Controller | Pixhawk 4 + Cube Orange+ | ✅ Connected (/dev/ttyACM0) |
| GPS | Here4 on CAN bus | ✅ Configured |
| Antenna | Log-periodic 850 MHz - 6.5 GHz | ✅ Available |
| Beacon | Software generated | ✅ No hardware needed |
| Battery | 6S Li-ion (Amprius cells) | ✅ Monitored via MAVLink |
| **Status** | **All hardware connected and configured** | **✅ READY** |

## Dependencies

- Story 4.3 must be complete (service integration)
- Story 4.4 CI/CD should be complete for automated hardware tests
- Physical access to Raspberry Pi 5 required
- Safe testing location required for field tests

## Risks

1. **Hardware Availability**: Lead time for components may delay testing
2. **Hardware Compatibility**: Selected hardware may have driver issues on Pi
3. **RF Regulations**: Must ensure compliance with local RF regulations
4. **Safety**: Field testing with drone requires appropriate safety measures
5. **Weather**: Field testing dependent on weather conditions

## Success Metrics

- Code coverage increases from 67% to 85%+
- All hardware-dependent code paths tested
- Zero hardware-related crashes in 1-hour stress test
- Detection range meets or exceeds 500m requirement
- False positive rate remains below 5% with real hardware
- Complete mission execution from detection to holding

## Mock/Simulated/Hardcoded Values Inventory

### CRITICAL: Complete inventory of all mock, fake, simulated, and hardcoded values that must be replaced with real hardware integration

#### 1. Beacon Simulator Service (`src/backend/services/beacon_simulator.py`)
**Purpose**: Complete RF beacon simulation for testing without physical beacons
**Mock/Simulated Elements**:
- Line 47-50: **HARDCODED** noise floor: `-110.0` dBm
- Line 48-50: **HARDCODED** propagation factor: `2.0` (free space path loss)
- Line 49-50: **HARDCODED** reference distance: `1.0` meter, loss: `40.0` dB
- Line 238: **SIMULATED** Gaussian noise: `random.gauss(0, 2)`
- Line 289: **PLACEHOLDER** receiver position: `(0, 0, 0)` - needs real GPS
- Line 210-252: **SIMULATED** RSSI calculation using path loss model
- Line 269-274: **SIMPLIFIED** distance calculation - needs haversine for GPS

#### 2. SDR Service (`src/backend/services/sdr_service.py`)
**Current State**: Attempts real hardware but has fallbacks
**Mock/Fallback Elements**:
- Line 83-85: Returns empty list `[]` when SoapySDR unavailable
- Line 139-142: Sets status to `"UNAVAILABLE"` when no SoapySDR
- Line 110-111: Raises `SDRNotFoundError` when no devices found
- **NO MOCK DATA GENERATION** - service fails gracefully without hardware

#### 3. MAVLink Service (`src/backend/services/mavlink_service.py`)
**Current State**: Attempts real connection but initializes with defaults
**Hardcoded/Default Elements**:
- Line 37: **DEFAULT** device path: `/dev/ttyACM0`
- Line 38: **DEFAULT** baud rate: `115200`
- Line 39-42: **DEFAULT** system/component IDs: `1, 191, 1, 1`
- Line 75: **HARDCODED** heartbeat timeout: `3.0` seconds
- Line 79-80: **HARDCODED** reconnect delays: `1.0` to `30.0` seconds
- Line 83-90: **INITIALIZED** telemetry with zeros/defaults:
  - Position: `lat=0.0, lon=0.0, alt=0.0`
  - Attitude: `roll=0.0, pitch=0.0, yaw=0.0`
  - Battery: `voltage=0.0, current=0.0, percentage=0.0`
  - GPS: `fix_type=0, satellites=0, hdop=0.0`
  - Flight mode: `"UNKNOWN"`
  - Armed: `False`
- Line 95-96: **HARDCODED** velocity limits: `0.1` sec rate, `5.0` m/s max
- Line 115: **DEFAULT** RSSI: `-100.0` dBm (noise floor)

#### 4. Signal Processor (`src/backend/services/signal_processor.py`)
**Hardcoded/Default Values**:
- Line 27: **DEFAULT** EWMA alpha: `0.3` (smoothing factor)
- Line 63-67: **DEFAULT** processing parameters:
  - FFT size: `1024`
  - SNR threshold: `12.0` dB
  - Noise window: `1.0` second
  - Sample rate: `2.048e6` Hz (2.048 MHz)
- Line 90: **INITIALIZED** noise floor: `-100.0` dBm
- Line 102: **HARDCODED** calibration offset: `-30.0` dBm (needs hardware calibration)
- Line 109: **DEFAULT** RSSI: `-100.0` dBm
- Line 159: **DEFAULT** RSSI rate: `2.0` Hz
- Line 207: **HARDCODED** floor value: `-120.0` dBm for zero power
- Line 269: **HARDCODED** minimum history: `10` samples for noise estimation

#### 5. Dependencies Service (`src/backend/core/dependencies.py`)
**Mock/Fallback Logic**:
- Line 56-63: **FALLBACK** logic for SDR initialization failure
- Service manager attempts real hardware but continues with degraded mode
- No explicit mock services - relies on service internal fallbacks

#### 6. Configuration File (`config/default.yaml`)
**Hardcoded Default Values**:
- Line 12: **DEFAULT** SDR frequency: `433920000` Hz (433.92 MHz)
- Line 13: **DEFAULT** SDR sample rate: `2048000` Hz (2.048 MHz)
- Line 14: **DEFAULT** SDR gain: `30` dB
- Line 15: **DEFAULT** PPM correction: `0`
- Line 17: **DEFAULT** buffer size: `16384`
- Line 20: **DEFAULT** RSSI threshold: `-70` dBm
- Line 21: **DEFAULT** averaging window: `10` samples
- Line 22-23: **DEFAULT** signal timing: `100` ms duration, `50` ms gap
- Line 51: **HARDCODED** max velocity: `2.0` m/s (safety)
- Line 76: **FLAG** `DEV_MOCK_SDR: false` - mock SDR toggle (NOT IMPLEMENTED)
- Line 79-90: **HARDCODED** homing algorithm parameters:
  - Forward velocity max: `5.0` m/s
  - Yaw rate max: `0.5` rad/s
  - Approach velocity: `1.0` m/s
  - Signal loss timeout: `5.0` seconds
  - Gradient window: `10` samples
  - Min SNR: `10.0` dB
  - Approach threshold: `-50.0` dBm
  - Plateau variance: `2.0`
  - Velocity scale: `0.1`

#### 7. State Machine (`src/backend/services/state_machine.py`)
**Hardcoded Values to Check**:
- State transition timeouts
- Default search patterns
- Safety limits

#### 8. Signal State Controller (`src/backend/services/signal_state_controller.py`)
**Hardcoded Thresholds (from Story 4.3)**:
- Line 60-61: **HARDCODED** trigger threshold: `12.0` dB
- Line 60-61: **HARDCODED** drop threshold: `6.0` dB
- Line 62-63: **HARDCODED** timing: `0.5` sec confirmation, `1.0` sec drop
- Line 64-65: **HARDCODED** anomaly detection: window `100`, threshold `3.0` Z-score

#### 9. Command Pipeline (`src/backend/services/command_pipeline.py`)
**Hardcoded Safety Limits**:
- Line 121: **HARDCODED** rate limit: `10.0` commands/sec
- Line 332: **HARDCODED** max altitude: `500` meters
- Line 346: **HARDCODED** max velocity: `20.0` m/s
- Line 384: **HARDCODED** takeoff altitude range: `1-100` meters

### Hardware Integration Requirements

#### SDR Hardware Integration Points:
1. **Replace**: Empty device list with actual SoapySDR enumeration
2. **Implement**: Real IQ sample streaming from hardware
3. **Calibrate**: Actual noise floor measurement
4. **Configure**: Hardware-specific gain/frequency settings
5. **Monitor**: Real temperature sensors

#### MAVLink Hardware Integration Points:
1. **Replace**: Default telemetry values with real flight controller data
2. **Connect**: Actual serial/USB connection to Pixhawk
3. **Stream**: Real GPS coordinates, battery status, attitude
4. **Execute**: Actual flight commands (arm, takeoff, land)
5. **Monitor**: Real heartbeat and connection status

#### Beacon Hardware Integration Points:
1. **Replace**: Entire beacon simulator with real beacon detection
2. **Implement**: Real RSSI measurements from SDR
3. **Calculate**: Actual signal propagation and multipath
4. **Remove**: Synthetic noise generation
5. **GPS**: Real receiver position from flight controller

### Critical Integration Priority:

1. **HIGHEST PRIORITY**: MAVLink telemetry (Line 83-90) - Safety critical
2. **HIGH**: SDR device detection and streaming
3. **HIGH**: Remove beacon simulator for real beacon
4. **MEDIUM**: Replace hardcoded thresholds with calibrated values
5. **LOW**: Optimize default configurations

### Summary of Mock/Simulated Infrastructure

#### Current State:
1. **NO EXPLICIT MOCK SERVICES**: The codebase does NOT have dedicated MockSDRService or MockMAVLinkService classes
2. **BEACON SIMULATOR**: The primary simulation infrastructure is the beacon_simulator.py service
3. **GRACEFUL DEGRADATION**: Services attempt real hardware and fail gracefully if unavailable
4. **HARDCODED DEFAULTS**: Extensive use of default values that work without hardware

#### Key Findings:
- **Total Hardcoded Values**: ~50+ configuration parameters and thresholds
- **Simulated Components**: Only beacon_simulator provides full simulation
- **Missing Mock Layer**: No proper mock service implementations for testing
- **Hardware Assumptions**: Code assumes hardware will provide real data

#### Critical Replacements Needed:
1. **Remove beacon_simulator.py entirely** when real beacon available
2. **Replace MAVLink telemetry defaults** (Line 83-90) with real GPS/attitude
3. **Calibrate signal processor offset** (Line 102: -30.0 dBm)
4. **Measure actual noise floor** (replace -100.0 dBm defaults)
5. **Configure hardware-specific parameters** in config/default.yaml

### Testing Strategy for Hardware:

```python
# Environment variable to switch between mock and real
if os.environ.get("USE_REAL_HARDWARE"):
    # Real hardware initialization
    sdr = SDRService()  # Will connect to actual SDR
    mavlink = MAVLinkService("/dev/ttyACM0")  # Real Pixhawk
    # DO NOT USE beacon_simulator - use real beacon
else:
    # Current fallback (needs improvement)
    sdr = SDRService()  # Will fail gracefully without hardware
    mavlink = MAVLinkService()  # Will use default telemetry
    # beacon_simulator provides simulated signals
```

### Recommended Implementation Order:
1. **Sprint 1**: Connect real SDR, remove beacon simulator
2. **Sprint 2**: Connect Pixhawk, replace telemetry defaults
3. **Sprint 3**: Calibrate all thresholds with real measurements
4. **Sprint 4**: Create proper MockService classes for CI/CD

## Dev Notes

### Relevant Architecture Information

**Hardware Abstraction Layer** [Source: 4.3.story.md]:
- SDR service already has mock fallback
- MAVLink service has auto-reconnection
- Service manager handles hardware initialization failures gracefully

**Current Coverage Gaps** [Source: 4.3.story.md Test Report]:
- SDR calibration routine: 210 lines uncovered
- MAVLink mission management: 104 lines uncovered
- Hardware sensor readings: ~50 lines uncovered
- Hardware error paths: ~100 lines uncovered

**Testing Strategy**:
```python
# Hardware test fixture example
@pytest.fixture
def real_sdr():
    """Fixture that only runs with real hardware."""
    if not os.environ.get("HARDWARE_TESTS"):
        pytest.skip("Hardware tests disabled")

    sdr = SDRService()
    sdr.initialize()
    yield sdr
    sdr.stop()
```

## Change Log

| Date       | Version | Description | Author |
|------------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation for hardware integration testing | Winston (Architect) |
| 2025-01-15 | 1.1 | Updated with backend reality - framework exists, hardware needed | Sentinel |
| 2025-01-15 | 2.0 | Complete hardware specification and HAL implementation | Sentinel |

## Backend Reality Update - Sentinel (2025-01-15)

### Backend Framework Status: COMPLETE

**What's Already Implemented:**
- ✅ SDR Service (`src/backend/services/sdr_service.py`) - Complete with mock support
- ✅ MAVLink Service (`src/backend/services/mavlink_service.py`) - Full implementation
- ✅ Signal Processor (`src/backend/services/signal_processor.py`) - RSSI/SNR analysis
- ✅ Hardware abstraction layer - Ready for real hardware

**What This Story Actually Needs:**
1. **Hardware Configuration File** (`config/hardware.yaml`):
   ```yaml
   sdr:
     device: "rtlsdr"  # or "hackrf", "usrp"
     frequency: 433920000
     sample_rate: 2048000
     gain: 30

   mavlink:
     connection: "serial:///dev/ttyAMA0:921600"
     # or "udp:127.0.0.1:14550"

   gpio:
     status_led: 17
     error_led: 27
     ready_led: 22
   ```

2. **Hardware Mock Improvements** (for testing without hardware):
   - Better SDR device simulation
   - MAVLink SITL integration
   - GPIO pin simulation

3. **Deployment Service** (`deployment/pisad.service`):
   ```ini
   [Unit]
   Description=PISAD RF Beacon Detection Service
   After=network.target

   [Service]
   Type=simple
   User=pisad
   WorkingDirectory=/home/pisad/projects/pisad
   ExecStart=/home/pisad/.local/bin/uv run uvicorn src.backend.core.app:app --host 0.0.0.0 --port 8080
   Restart=on-failure
   RestartSec=5

   [Install]
   WantedBy=multi-user.target
   ```

**Coverage Impact:**
- Current: 62.56% (software only)
- After hardware mocks: 67%
- With real hardware: 85%+

## Acceptance Testing Checklist

- [ ] SDR hardware detected and initialized
- [ ] Flight controller connected and responding
- [ ] Complete signal detection pipeline tested
- [ ] Mission execution tested end-to-end
- [ ] Code coverage report shows 85%+
- [ ] Field test report completed
- [ ] Performance benchmarks documented
- [ ] Hardware configuration guide created
